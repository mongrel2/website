<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>5 Hacking</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- index=1,2,next,fn-in,html --> 
<meta name="src" content="book-final.tex"> 
<meta name="date" content="2012-10-01 21:58:00"> 
<link rel="stylesheet" type="text/css" href="book-final.css"> 
</head><body 
>
<!--l. 1--><div class="crosslinks"><p class="noindent">[<a 
href="book-finalch7.html" >next</a>] [<a 
href="book-finalch5.html" >prev</a>] [<a 
href="book-finalch5.html#tailbook-finalch5.html" >prev-tail</a>] [<a 
href="#tailbook-finalch6.html">tail</a>] [<a 
href="book-final.html#book-finalch6.html" >up</a>] </p></div>
<h2 class="chapterHead"><span class="titlemark">Chapter&#x00A0;5</span><br /><a 
 id="x8-600005"></a>Hacking</h2>
<!--l. 3--><p class="noindent" >This chapter is all about making cool things with Mongrel2. It covers all
the non-deployment features that you get from the browser&#8217;s side and the
handler/backend side of your application. I&#8217;ll show you how the chat demo works
for the async web sockets. I&#8217;ll get into writing your own handlers using a few other
demos. I&#8217;ll cover some of the interesting things you can do with Mongrel2 you can&#8217;t
do with other servers. Finally, I&#8217;ll get into practical things, when to do proxying and
when to use a 0MQ handler.
<!--l. 10--><p class="noindent" >For the majority of this chapter, I&#8217;ll be using Python, but the demos should translate
to the other languages that are implemented. I&#8217;ll periodically show how another
language does one of the demos, so you can get the idea that Mongrel2 is <span 
class="pplri7t-">language</span>
<span 
class="pplri7t-">agnostic</span>. In no way should you take me using Python in this chapter to mean you
can&#8217;t use something else for your handlers.
<!--l. 16--><p class="noindent" >Currently supported languages are:
     <dl class="description"><dt class="description">
<span 
class="pplb7t-">Python</span> </dt><dd 
class="description">The   directory   <span 
class="pcrb7t-">examples/python </span>contain   the   Mongrel2   Python
     library <span 
class="pcrro7t-">m2py</span>.
     </dd><dt class="description">
<span 
class="pplb7t-">Ruby</span> </dt><dd 
class="description">Probably  the  most  extensively  supported  language,  with  good  Rack
     support, by <a 
href="http://github.com/perplexes/m2r" >perplexes on github</a>.
     </dd><dt class="description">
<span 
class="pplb7t-">C++</span> </dt><dd 
class="description">C++ support by <a 
href="http://github.com/akrennmair/mongrel2-cpp" >akrennmair on github</a>.
     </dd><dt class="description">
<span 
class="pplb7t-">PHP</span> </dt><dd 
class="description">PHP support by <a 
href="http://github.com/winks/m2php" >winks on github</a>.
     </dd><dt class="description">
<span 
class="pplb7t-">C</span> </dt><dd 
class="description">You can also write handlers in C using the Mongrel2 library, but it&#8217;s really
     rough, and not recommended yet. A C library will come, though.
     </dd><dt class="description">
<span 
class="pplb7t-">Others?</span> </dt><dd 
class="description"><a 
href="http://zeromq.org" >ZeroMQ</a>  supports  Ada,  Basic,  C,  C++,  Common  Lisp,  Erlang,  Go,
     Haskell, Java, Lua, .NET, Objective-C, ooc, Perl, PHP, Python, and Ruby,
     so after reading this chapter you can easily write handlers in any of those
     languages too.</dd></dl>
<!--l. 27--><p class="noindent" >However, no matter how many languages Mongrel2 supports, you will still have
applications that can&#8217;t fit into 0MQ handlers and just work better as classic
web apps, either because you&#8217;ve already written them and have existing
infrastructure, or because of some architectural issues that require it to run
                                                                  

                                                                  
traditionally. Because of that, Mongrel2 supports <span 
class="pplri7t-">HTTP proxying</span>, which
allows you to route requests to basic web server backends that don&#8217;t support
0MQ.
                                                                  

                                                                  
<!--l. 33--><p class="noindent" ><a 
 id="x8-60001r7"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Note 7: </span><span  
class="content">                                                                                                       <span 
class="pplri7t-">What About</span>
<span 
class="pplri7t-">FastCGI/AJP/CGI/SCGI/WSGI/Rack?</span></span></div><!--tex4ht:label?: x8-60001r7 -->
     <div class="quote">
     <!--l. 34--><p class="indent" >   Nothing prevents you from writing your own connector between
     Mongrel2  and  your  deployment  protocol  of  choice.  If  you  need
     to  run  FastCGI  or  AJP  in  your  environment,  then  your  best  bet
     is to just make a handler that translates Mongrel2 requests to the
     protocol you need and back. The Mongrel2 format is very easy to
     parse and translate, so you should be able to do it with no problem.
     The Ruby library already supports Rack as an example, and Python
     will support WSGI soon.
     <!--l. 41--><p class="indent" >   However, Mongrel2 itself doesn&#8217;t support any of these directly.
     Doing  so  would  bring  back  the  language  specific  infections  that
     cause other web servers to go south. The design of most of these
     protocols tends to be either before the modern web, or specific to
     one particular language. Instead of trying to cater to all the possible
     languages out there, Mongrel2 just gives the tools to connect to it
     yourself. </div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<h3 class="sectionHead"><span class="titlemark">5.1    </span> <a 
 id="x8-610005.1"></a>Front-end Goodies</h3>
<!--l. 51--><p class="noindent" >Mongrel2 supports your standard web server features like serving files,
routing requests to another HTTP server, multiple host matching, good 304
support, and just generally being able to interact with a browser like normal.
You&#8217;ve seen most of these features as you setup and deployed a Mongrel2
configuration, but let&#8217;s go through some of them in more detail so you know what&#8217;s
possible.
<!--l. 58--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.1    </span> <a 
 id="x8-620005.1.1"></a>HTTP</h4>
<!--l. 60--><p class="noindent" >Mongrel2 uses the original Mongrel parser that powers quite a few other
web servers and large, successful websites. This parser is rock solid, dead
accurate, and by design blocks a lot of security attacks. For the most part you
don&#8217;t have to worry about this and just need to know Mongrel2 is using
the same stable HTTP processing that has been working great for many
years.
<!--l. 65--><p class="noindent" >Another way to put this is if Mongrel2 says your request is invalid, it most definitely
is.
                                                                  

                                                                  
<!--l. 67--><p class="noindent" ><a 
 id="x8-62001r8"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Note 8: </span><span  
class="content">                                                                                                   <span 
class="pplri7t-">Idiots and RFC</span>
<span 
class="pplri7t-">Implementers</span></span></div><!--tex4ht:label?: x8-62001r8 -->
     <div class="quote">
     <!--l. 68--><p class="indent" >   I  don&#8217;t  know  why,  but  people  who  implement  RFCs  pick  up
     very weird cargo cult beliefs peddled by the people who write the
     standards. In HTTP it was two things which the creators of HTTP
     have actually back-peddled on: Accept everything, and keep-alives
     with pipe-lines.
     <!--l. 73--><p class="indent" >   The  truth  is,  if  you  want  a  secure  server  of  <span 
class="pplri7t-">any  </span>kind,  blindly
     accepting every single thing any idiot sends you is going to open
     your server up to a huge number of attacks. If you look at every
     attack  on  existing  HTTP  servers  you&#8217;ll  find  that  about  80%  of
     them are exploiting ambiguous parts of the HTTP grammar to pass
     through malicious content or overflow buffers. In Mongrel2 we use
     a parser that rejects invalid requests from first basic principles using
     technology that&#8217;s 30 years old and backed by solid mathematics.
     Not  only  does  Mongrel2  reject  bad  requests,  but  it  can  tell  you
     <span 
class="pplri7t-">why </span>the request was bad, just like a compiler. This doesn&#8217;t mean
     Mongrel2 is ruthless, but it definitely doesn&#8217;t tolerate ambiguity or
     stupidity.
     <!--l. 84--><p class="indent" >   Mongrel2 completey supports keep-alives because now, since it&#8217;s
     not using Ruby <span 
class="pplri7t-">at all </span>it can scale up beyond 1024 file descriptors.
     Ruby was limited in the number of open files a process could have,
     so the original Mongrel had to break keep-alive and kill connections
     in order to save itself from greedy browsers that never close them.
     Mongrel2 doesn&#8217;t have this limitation, so it uses full keep-alives and
     has a dead accurate state machine to manage them correctly.
     <!--l. 91--><p class="indent" >   Where problems come in is with pipe-lined requests, meaning a
     browser sends a bunch of requests in a big blast, then hangs out for
     all the responses. This was such a horrible stupid idea that pretty
     much everone gets it wrong and doesn&#8217;t support it fully, if at all.
     The  reason  is  it&#8217;s  much  too  easy  to  blast  a  server  with  a  ton  of
     request, wait a bit so they hit proxied backends, and then close the
     socket. The web server and the backends are now screwed having
     to handle these requests which will go nowhere.
     <!--l. 99--><p class="indent" >   Mongrel2 does <span 
class="pplri7t-">not </span>support pipe-lined requests. It sends one, and
     waits for the reponse, and if you want more, then tough. Screw you
     because it has <span 
class="pplri7t-">no </span>advantage for Mongrel2 and dubious advantages
     to  you.  It  is  simply  one  more  attack  vector  for  the  server  and  is
     rejected outright.
     <!--l. 104--><p class="indent" >   These  two  things  are  rejected  outright  by  Mongrel2  simply
                                                                  

                                                                  
     because they are stupid ideas and in 2010 nobody should be writing
     clients so badly that they need these features. </div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<h4 class="subsectionHead"><span class="titlemark">5.1.2    </span> <a 
 id="x8-630005.1.2"></a>Proxying</h4>
<!--l. 110--><p class="noindent" >You&#8217;ve already seen configurations that have the Proxy routes working, so it should
be easy to understand what&#8217;s going on. You just create routes to backends that are
HTTP servers and Mongrel2 shuttles requests to them, then proxies responses
back.
<!--l. 114--><p class="noindent" >The Proxying support in Mongrel2 is accurate, but it&#8217;s not very capable right now.
For example, there&#8217;s not round-robin backend selection, or page caching, or other
things you might need for more serious deployments. Those features will come
eventually, though.
<!--l. 118--><p class="noindent" >What you do get with Mongrel2&#8217;s proxying, though, is a dead accurate way of
slicing up your application by routes. Other web servers make you go through great
pain in order to have some URLs go to a proxy and others go to handlers or
directories. They make you use odd &#8220;file syntax&#8221;, weird pseudo-turing logic
if-statements, and other odd hacks to get flexible route selection. They also tend
to not maintain keep-alives properly between proxy requests and other
requests.
<!--l. 125--><p class="noindent" >Mongrel2 uses the exact same routing syntax for all backends and has no distinction
between them. It also properly does keep-alives for as long as it is efficient to do
so.
                                                                  

                                                                  
<!--l. 128--><p class="noindent" ><a 
 id="x8-63001r9"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Note 9: </span><span  
class="content">                                                            <span 
class="pplri7t-">Proxying And 0MQ Handlers Are Like</span>
<span 
class="pplri7t-">mod</span><span 
class="pplri7t-">_*</span></span></div><!--tex4ht:label?: x8-63001r9 -->
     <div class="quote">
     <!--l. 129--><p class="indent" >   A quick note for people coming from other web servers. If you use
     nginx then you are probably familiar with the concept of proxying
     to a &#8220;backend&#8221; like Ruby on Rails or Django. If you use PHP or
     another  language,  you  may  be  used  to  a  system  like  <span 
class="pcrro7t-">mod</span><span 
class="pcrro7t-">_php</span>
     which  manages  your  code  for  you  and  reloads  when  you  make
     changes. If you use Apache, then you probably think in terms of
     &#8220;virtual hosts&#8221; and &#8220;mod_rewrite rules&#8221;.
     <!--l. 135--><p class="indent" >   In Mongrel2 all the same concepts are there, it&#8217;s just cleaned up. If
     you want Mongrel2 to &#8220;nginx/mod_rewrite style&#8221; talk to another
     backend web server, then that&#8217;s Proxying. If you want to have fast
     backend handlers then that&#8217;s 0MQ Handlers.
     <!--l. 139--><p class="indent" >   We really don&#8217;t have anything like mod_php because the whole
     idea   of   embedding   a   programming   language   runtime   inside
     Mongrel2 would defeat the point of making it language agnostic. </div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<h4 class="subsectionHead"><span class="titlemark">5.1.3    </span> <a 
 id="x8-640005.1.3"></a>WebSockets</h4>
<!--l. 145--><p class="noindent" >Mongrel2 does not support WebSockets because the original protocol was a
complete ugly hack with security holes galore. They&#8217;ve since fixed the entire
protocol and we&#8217;ll be implementing the <a 
href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-07" >hybi-07</a> version of the protocol in the 1.7 or
1.8 release.
<!--l. 151--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.4    </span> <a 
 id="x8-650005.1.4"></a>JSSocket</h4>
<!--l. 153--><p class="noindent" >The Mongrel2 chat demo uses JSSocket to do its magic, and it works great, but it
requires Flash and, oh, man, do I absolutely hate Flash. However, it works, and
works now, and works in every browser, even really old, busted ones. That means
it&#8217;s the first thing we implemented and the one we&#8217;ll keep for a while until it proves
itself not useful. The chat demo we&#8217;ll cover will show you how to hook this up for
fast async messaging and presence detection.
<!--l. 160--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.5    </span> <a 
 id="x8-660005.1.5"></a>Long Poll</h4>
<!--l. 162--><p class="noindent" >Mongrel2 just works as if everything is an HTTP long poll, it&#8217;s just that normal
request/responses are super fast long polls. For the most part you don&#8217;t even need
to know this exists; it&#8217;s just how things are and they make perfect sense.
You get requests from a certain server with a certain connected identity,
and then you send stuff to that target. That&#8217;s it. If you send it one response,
or a stream of them, or setup a long poll configuration, then that&#8217;s up to
you.
<!--l. 169--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.6    </span> <a 
 id="x8-670005.1.6"></a>Streaming</h4>
<!--l. 171--><p class="noindent" >Because everything in Mongrel2 is asynchronous, and it allows you to target any
connected listeners from your handlers, even with partial messages, you can easily
                                                                  

                                                                  
do efficient streaming applications. ZeroMQ is an incredibly efficient transport
mechanism, and with it you can send tons of information to many browsers or
clients at once. This means streaming video and MP3 streams to listeners is very
trivial. We&#8217;ll cover the mp3stream example where you get to see a simple
implementation of the ICY MP3 streaming protocol.
<!--l. 178--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.7    </span> <a 
 id="x8-680005.1.7"></a>N:M Responses</h4>
<!--l. 180--><p class="noindent" >What makes streaming, async messaging, and long poll designs so efficient in
Mongrel2 is that you can send <span 
class="pplri7t-">one </span>message and target up to 128 clients with that one
message. This means sending large scale replies to many browsers requires less
copying of the message and less transports.
<!--l. 184--><p class="noindent" >In addition to this, you can setup Mongrel2 with the help of some 0MQ to send one
request from a browser to as many target handlers as you like. You can even send
them messages using <a 
href="http://code.google.com/p/openpgm/" >OpenPGM</a> for sending UDP messages reliably to clusters of
computers.
<!--l. 189--><p class="noindent" >This means that Mongrel2 is the only web server capable of sending one request
from a browser to N backends at once, and then return the replies from these
handlers to M browsers. Not exactly sure what you could write with that, but it&#8217;s
probably something really damn cool.
<!--l. 194--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.1.8    </span> <a 
 id="x8-690005.1.8"></a>Async Uploads</h4>
<!--l. 196--><p class="noindent" >Mongrel2 also solves the problem of large uploads choking your server because you
can&#8217;t stop them before they&#8217;re complete. Mongrel2 will stream large requests
to temporary files, but it sends your handlers an initial &#8220;upload started&#8221;
message. When the upload is done, you get a final &#8220;upload finished&#8221; message.
If, at any time, you want to kill the upload, you just send a 0-length reply
(the official KILL MESSAGE) and the whole thing is aborted and cleaned
up.
<!--l. 205--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.2    </span> <a 
 id="x8-700005.2"></a>Introduction to ZeroMQ</h3>
                                                                  

                                                                  
<!--l. 207--><p class="noindent" >The ZeroMQ folks have finally written a decent manual for ZeroMQ which you
should probably read. I recommend you read the <a 
href="http://zguide.zeromq.org/page:all" >&#8220;0MQ - The Guide&#8221;</a> as your
introduction to 0MQ.
<!--l. 211--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.3    </span> <a 
 id="x8-710005.3"></a>Handler ZeroMQ Format</h3>
<!--l. 213--><p class="noindent" >You&#8217;ve read the <a 
href="http://zguide.zeromq.org/page:all" >0MQ Guide</a> and now you&#8217;re ready to see how Mongrel2 talks to
your handlers with it. I won&#8217;t really call this a &#8220;protocol&#8221;, since ZeroMQ is really
doing the protocol, and we just pull fully baked messages out of it. Instead, this is
just a format, as if you got strings out of a file or something similar. This
message format is designed to accomplish a few things in the simplest way
possible:
<!--l. 219--><p class="noindent" >
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x8-71002x1">Be  usable  from  languages  that  are  statically  compiled  or  scripting
     languages.
     </li>
     <li 
  class="enumerate" id="x8-71004x2">Be safe from buffer overflows if done right, or easy to do right.
     </li>
     <li 
  class="enumerate" id="x8-71006x3">Be easy to understand and require very little code.
     </li>
     <li 
  class="enumerate" id="x8-71008x4">Be language agnostic and use a data format everyone can accept without
     complaining that it should be done with their favorite<span class="footnote-mark"><a 
href="#fn1x7" id="fn1x7-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x8-71009f1"></a>.
     </li>
     <li 
  class="enumerate" id="x8-71011x5">Be easy to parse and generate inside Mongrel2 <span 
class="pplri7t-">without </span>have to parse the
     entire message to do routing or analysis.
     </li>
     <li 
  class="enumerate" id="x8-71013x6">Be useful within ZeroMQ so that you can do subscriptions and routing.</li></ol>
<!--l. 231--><p class="noindent" >To satisfy these features we use different types of ZeroMQ sockets (soon to be
configurable), a request format that Mongrel2 sends and a response format that the
handlers send back. Most importantly, there is <span 
class="pplri7t-">nothing about the request and response</span>
<span 
class="pplri7t-">that must be connected</span>. In most cases they will be connected, but you can
receive a request from one browser and send a response to a totally different
one.
                                                                  

                                                                  
<!--l. 237--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.1    </span> <a 
 id="x8-720005.3.1"></a>Socket Types Used</h4>
<!--l. 239--><p class="noindent" >First, the types of ZeroMQ sockets used are a <span 
class="pcrro7t-">ZMQ</span><span 
class="pcrro7t-">_PUSH </span>socket for messages
from Mongrel2 to Handlers, which means your Handler&#8217;s receive socket
should be a <span 
class="pcrro7t-">ZMQ</span><span 
class="pcrro7t-">_PULL</span>. Mongrel2 then uses a <span 
class="pcrro7t-">ZMQ</span><span 
class="pcrro7t-">_SUB </span>socket for receiving
responses, which means your Handlers should send on a <span 
class="pcrro7t-">ZMQ</span><span 
class="pcrro7t-">_PUB </span>socket.
This setup allows multiple handlers to connect to a Mongrel2 server, but
only one Handler will get a message in a round-robin style. The PUB/SUB
reply sockets, though, will let Handlers send back replies to a cluster of
Mongrel2 servers, but only the one with the right subscription will process the
request.<span class="footnote-mark"><a 
href="#fn2x7" id="fn2x7-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x8-72001f2"></a>
<!--l. 251--><p class="noindent" >In the various APIs we&#8217;ve implemented, you don&#8217;t need to care about this. They
provide an abstraction on top of this, but it does help to know it so that you
understand why the message format is the way it is.
<!--l. 255--><p class="noindent" >This leads to rule number 1:
<!--l. 257--><p class="noindent" >
     <div class="quote">
     <!--l. 258--><p class="noindent" ><span 
class="pplri7t-">Rule 1: </span>Handlers receive with PULL and send with PUB sockets.</div>
<!--l. 261--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.2    </span> <a 
 id="x8-730005.3.2"></a>UUID Addressing</h4>
<!--l. 263--><p class="noindent" >Do you remember all those UUIDs all over the place in the configuration files? They
may have seemed odd, but they identify specific server deployments and processes
in a cluster. This will let you identify exactly which member of a cluster sent a
message, so that you can return the right reply. This is the first part of our protocol
format and it results in the next rule 2:
<!--l. 269--><p class="noindent" >
     <div class="quote">
     <!--l. 270--><p class="noindent" ><span 
class="pplri7t-">Rule  2:  </span>Every  message  to  and  from  Mongrel2  has  that  Mongrel2
     instance&#8217;s UUID as the very first thing.</div>
                                                                  

                                                                  
<!--l. 274--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.3    </span> <a 
 id="x8-740005.3.3"></a>Numbers Identify Listeners</h4>
<!--l. 276--><p class="noindent" >You then need a way to identify a particular listener (browser, client, etc.)
that your message should target, <span 
class="pplri7t-">and </span>Mongrel2 needs to tell you who is
sending your handler the request. This means Mongrel2 sends you just
one identifier, but you can send Mongrel2 a list of them. This leads to rule
3:
<!--l. 281--><p class="noindent" >
     <div class="quote">
     <!--l. 282--><p class="noindent" ><span 
class="pplri7t-">Rule 3: </span>Mongrel2 sends requests with one number right after the
     server&#8217;s  UUID  separated  by  a  space.  Handlers  return  a  <span 
class="pplri7t-">netstring</span>
     with a list of numbers separated by spaces. The numbers indicate
     the connected browser the message is to/from.</div>
<!--l. 288--><p class="noindent" >In case you don&#8217;t know what a netstring is, it is a very simple way to encode a block
of data such that any language can read the block and know how big it is. A
netstring is, simply, <span class="obeylines-h"><span class="verb"><span 
class="pcrr7t-">SIZE:DATA,</span></span></span>. So, to send &#8220;HI&#8221;, you would do <span class="obeylines-h"><span class="verb"><span 
class="pcrr7t-">2:HI,</span></span></span>, and it is
<span 
class="pplri7t-">incredibly </span>easy to parse in every language, even C. It is also a fast format and you can
read it even if you&#8217;re a human.
<!--l. 295--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.4    </span> <a 
 id="x8-750005.3.4"></a>Paths Identify Targets</h4>
<!--l. 297--><p class="noindent" >In order to make it possible to route or analyze a request in your handlers without
having to parse a full request, every request has the path that was matched in the
server as the next piece. That gives us:
<!--l. 301--><p class="noindent" >
     <div class="quote">
     <!--l. 302--><p class="noindent" ><span 
class="pplri7t-">Rule 4: </span>Requests have the path as a single string followed by a space
     and <span 
class="pplri7t-">no paths may have spaces in them</span>.</div>
<!--l. 307--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.5    </span> <a 
 id="x8-760005.3.5"></a>Request Headers And Body</h4>
                                                                  

                                                                  
<!--l. 309--><p class="noindent" >We only have two more rules to complete the message format.
<!--l. 311--><p class="noindent" >
     <div class="quote">
     <!--l. 312--><p class="noindent" ><span 
class="pplri7t-">Rule 5: </span>Mongrel2 sends requests with a <span 
class="pcrro7t-">netstring </span>that contains
     a  JSON  hash  (dict)  of  the  request  headers,  and  then  another
     <span 
class="pcrro7t-">netstring </span>with the body of the request.</div>
<!--l. 317--><p class="noindent" >Then there&#8217;s a similar rule for responses:
<!--l. 319--><p class="noindent" >
     <div class="quote">
     <!--l. 320--><p class="noindent" ><span 
class="pplri7t-">Rule 6: </span>Handlers return just the body after a space character. It can
     be <span 
class="pplri7t-">any </span>data that Mongel2 is supposed to send to the listeners.</div>
<!--l. 324--><p class="noindent" >HTTP headers, image data, HTML pages, streaming video&hellip;You can also
send as many as you like to complete the request and any handler can send
it.
<!--l. 328--><p class="noindent" >
<h4 class="subsectionHead"><span class="titlemark">5.3.6    </span> <a 
 id="x8-770005.3.6"></a>Complete Message Examples</h4>
<!--l. 330--><p class="noindent" >Now, even though we laid out all of this as a series of rules, the actual code to
implement these is very simple. First here&#8217;s a simple &#8220;grammar&#8221; for how a request
that gets sent to your handlers is formatted:
<!--l. 334--><p class="noindent" >
<div class="fancyvrb" id="fancyvrb29">
<a 
 id="x8-77002r1"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;UUID</span><span 
class="pcrr7t-">&#x00A0;ID</span><span 
class="pcrr7t-">&#x00A0;PATH</span><span 
class="pcrr7t-">&#x00A0;SIZE:HEADERS,SIZE:BODY,</span>
</div>
<!--l. 338--><p class="noindent" >That&#8217;s obviously a much simpler way to specify the request than all those rules, but
it also doesn&#8217;t tell you why. The above description, while boring as hell, tells you
why each of these pieces exist. Also remember that this is a <span 
class="pplri7t-">strict </span>format, so to be
more precise it&#8217;s:
<!--l. 343--><p class="noindent" >
<div class="fancyvrb" id="fancyvrb30">
                                                                  

                                                                  
<a 
 id="x8-77004r1"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;Identifier</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;digit+</span><span 
class="pcrr7t-">&#x00A0;'</span><span 
class="pcrr7t-">&#x00A0;'?;</span>
<br class="fancyvrb" /><a 
 id="x8-77006r2"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;IdentList</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;(Identifier)&#x22C6;&#x22C6;;</span>
<br class="fancyvrb" /><a 
 id="x8-77008r3"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;Length</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;digit+;</span>
<br class="fancyvrb" /><a 
 id="x8-77010r4"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;UUID</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;(alpha</span><span 
class="pcrr7t-">&#x00A0;|</span><span 
class="pcrr7t-">&#x00A0;digit</span><span 
class="pcrr7t-">&#x00A0;|</span><span 
class="pcrr7t-">&#x00A0;'-')+;</span>
<br class="fancyvrb" /><a 
 id="x8-77012r5"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;Targets</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;Length</span><span 
class="pcrr7t-">&#x00A0;':'</span><span 
class="pcrr7t-">&#x00A0;IdentList</span><span 
class="pcrr7t-">&#x00A0;",";</span>
<br class="fancyvrb" /><a 
 id="x8-77014r6"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;Request</span><span 
class="pcrr7t-">&#x00A0;=</span><span 
class="pcrr7t-">&#x00A0;UUID</span><span 
class="pcrr7t-">&#x00A0;'</span><span 
class="pcrr7t-">&#x00A0;'</span><span 
class="pcrr7t-">&#x00A0;Targets</span><span 
class="pcrr7t-">&#x00A0;'</span><span 
class="pcrr7t-">&#x00A0;';</span>
</div>
<!--l. 352--><p class="noindent" >Mongrel2 will strictly enforce this grammar and reject any 0mq messages that don&#8217;t
follow it.
<!--l. 355--><p class="noindent" >To parse this in Python we simply do this:
                                                                  

                                                                  
<!--l. 357--><p class="noindent" ><a 
 id="x8-77015r32"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 32: </span><span  
class="content">                                                                     <span 
class="pplri7t-">Parsing Mongrel2 Requests In</span>
<span 
class="pplri7t-">Python</span></span></div><!--tex4ht:label?: x8-77015r32 -->
<div class="fancyvrb" id="fancyvrb31">
<a 
 id="x8-77017r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor357"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor358"><span 
class="pcrb7t-x-x-90">json</span></span>
<br class="fancyvrb" /><a 
 id="x8-77019r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77021r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor359"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor360"><span 
class="pcrb7t-x-x-90">parse_netstring</span></span><span 
class="pcrr7t-x-x-90">(ns):</span>
<br class="fancyvrb" /><a 
 id="x8-77023r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor361"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;ns.split(</span><span 
class="colorbox" id="colorbox362"><span id="textcolor363"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox364"><span id="textcolor365"><span 
class="pcrr7t-x-x-90">:</span></span></span><span 
class="colorbox" id="colorbox366"><span id="textcolor367"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor368"><span 
class="pcrb7t-x-x-90">1</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-77025r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor369"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor370"><span 
class="pcrr7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor371"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-77027r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor372"><span 
class="pcrb7t-x-x-90">assert</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;rest[</span><span id="textcolor373"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">]</span><span 
class="pcrr7t-x-x-90">&#x00A0;==</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox374"><span id="textcolor375"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox376"><span id="textcolor377"><span 
class="pcrr7t-x-x-90">,</span></span></span><span 
class="colorbox" id="colorbox378"><span id="textcolor379"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox380"><span id="textcolor381"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox382"><span id="textcolor383"><span 
class="pcrr7t-x-x-90">Netstring</span><span 
class="pcrr7t-x-x-90">&#x00A0;did</span><span 
class="pcrr7t-x-x-90">&#x00A0;not</span><span 
class="pcrr7t-x-x-90">&#x00A0;end</span><span 
class="pcrr7t-x-x-90">&#x00A0;in</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox384"><span id="textcolor385"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox386"><span id="textcolor387"><span 
class="pcrr7t-x-x-90">,</span></span></span><span 
class="colorbox" id="colorbox388"><span id="textcolor389"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox390"><span id="textcolor391"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-77029r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor392"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;rest[:</span><span id="textcolor393"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">],</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest[</span><span id="textcolor394"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">+</span><span id="textcolor395"><span 
class="pcrb7t-x-x-90">1</span></span><span 
class="pcrr7t-x-x-90">:]</span>
<br class="fancyvrb" /><a 
 id="x8-77031r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77033r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor396"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor397"><span 
class="pcrb7t-x-x-90">parse</span></span><span 
class="pcrr7t-x-x-90">(msg):</span>
<br class="fancyvrb" /><a 
 id="x8-77035r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender,</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path,</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;msg.split(</span><span 
class="colorbox" id="colorbox398"><span id="textcolor399"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox400"><span id="textcolor401"><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox402"><span id="textcolor403"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor404"><span 
class="pcrb7t-x-x-90">3</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-77037r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;parse_netstring(rest)</span>
<br class="fancyvrb" /><a 
 id="x8-77039r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;body,</span><span 
class="pcrr7t-x-x-90">&#x00A0;_</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;parse_netstring(rest)</span>
<br class="fancyvrb" /><a 
 id="x8-77041r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77043r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;json.loads(headers)</span>
<br class="fancyvrb" /><a 
 id="x8-77045r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77047r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor405"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;uuid,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor406"><span 
class="pcrr7t-x-x-90">id</span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path,</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;body</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 379--><p class="noindent" >This is actually all of the code needed to parse a request, and is fairly the same in many
other languages. If you look at the file <span 
class="pcrb7t-">examples/python/mongrel2/request.py</span>,
you&#8217;ll see a more complete example of making a full request object.
<!--l. 384--><p class="noindent" >A response is then just as simple and involves crafting a similar setup like
this:
<div class="fancyvrb" id="fancyvrb32">
<a 
 id="x8-77049r1"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;UUID</span><span 
class="pcrr7t-">&#x00A0;SIZE:ID</span><span 
class="pcrr7t-">&#x00A0;ID</span><span 
class="pcrr7t-">&#x00A0;ID,</span><span 
class="pcrr7t-">&#x00A0;BODY</span>
</div>
<!--l. 391--><p class="noindent" >Notice I&#8217;ve got three IDs here, but you can do anywhere from 1 up to 128. Generating
this is very easy in Python:
                                                                  

                                                                  
<!--l. 394--><p class="noindent" ><a 
 id="x8-77050r33"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 33: </span><span  
class="content">                                                                                                    <span 
class="pplri7t-">Generating</span>
<span 
class="pplri7t-">Responses</span></span></div><!--tex4ht:label?: x8-77050r33 -->
<div class="fancyvrb" id="fancyvrb33">
<a 
 id="x8-77052r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor407"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor408"><span 
class="pcrb7t-x-x-90">send</span></span><span 
class="pcrr7t-x-x-90">(uuid,</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;msg):</span>
<br class="fancyvrb" /><a 
 id="x8-77054r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;header</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox409"><span id="textcolor410"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox411"><span id="textcolor412"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox413"><span id="textcolor414"><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox415"><span id="textcolor416"><span 
class="pcrr7t-x-x-90">%d</span></span></span><span 
class="colorbox" id="colorbox417"><span id="textcolor418"><span 
class="pcrr7t-x-x-90">:</span></span></span><span 
class="colorbox" id="colorbox419"><span id="textcolor420"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox421"><span id="textcolor422"><span 
class="pcrr7t-x-x-90">,</span></span></span><span 
class="colorbox" id="colorbox423"><span id="textcolor424"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;(uuid,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor425"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor426"><span 
class="pcrr7t-x-x-90">str</span></span><span 
class="pcrr7t-x-x-90">(conn_id)),</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor427"><span 
class="pcrr7t-x-x-90">str</span></span><span 
class="pcrr7t-x-x-90">(conn_id))</span>
<br class="fancyvrb" /><a 
 id="x8-77056r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor428"><span 
class="pcrr7t-x-x-90">self</span></span><span 
class="pcrr7t-x-x-90">.resp.send(header</span><span 
class="pcrr7t-x-x-90">&#x00A0;+</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox429"><span id="textcolor430"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox431"><span id="textcolor432"><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox433"><span id="textcolor434"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;+</span><span 
class="pcrr7t-x-x-90">&#x00A0;msg)</span>
<br class="fancyvrb" /><a 
 id="x8-77058r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77060r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-77062r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor435"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor436"><span 
class="pcrb7t-x-x-90">deliver</span></span><span 
class="pcrr7t-x-x-90">(uuid,</span><span 
class="pcrr7t-x-x-90">&#x00A0;idents,</span><span 
class="pcrr7t-x-x-90">&#x00A0;data):</span>
<br class="fancyvrb" /><a 
 id="x8-77064r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor437"><span 
class="pcrr7t-x-x-90">self</span></span><span 
class="pcrr7t-x-x-90">.send(uuid,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox438"><span id="textcolor439"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox440"><span id="textcolor441"><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox442"><span id="textcolor443"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">.join(idents),</span><span 
class="pcrr7t-x-x-90">&#x00A0;data)</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 407--><p class="noindent" >That, again, is all there is to it. The <span 
class="pcrro7t-">send </span>method is the one doing the real work of
crafting the response, and the <span 
class="pcrro7t-">deliver </span>method is just using <span 
class="pcrro7t-">send </span>to do all the the
target idents joined with a space.
<h4 class="subsectionHead"><span class="titlemark">5.3.7    </span> <a 
 id="x8-780005.3.7"></a>TNetStrings Alternative Protocol</h4>
<!--l. 413--><p class="noindent" >During the 1.6 development, it became clear that we needed a sort of &#8220;internal&#8221;
protocol for some new Mongrel2 features. This internal protocol should be able to
store all the same things that JSON can, but also store exact binary data. This came
about because we want to send raw data to handlers and other parts of the system
like the control port, but JSON involved too much work to parse and deal with that.
We also did various analyses and found that much of our time was spent just
generating JSON.
<!--l. 421--><p class="noindent" >What we did, then, is create a small modification to netstrings that &#8220;tags&#8221; each
element with its type. We did this by changing the (fairly useless) trailing &#8216;,&#8217;
character so that it signified the type of what it contained. Types can be any of the
main data types that JSON has (dicts, lists, integers, etc.), except that &#8220;strings&#8221; are
now entirely raw binary strings, with no definition about whether they hold
anything other than 8-bit octets.
<!--l. 428--><p class="noindent" >We also made the design so it was backward compatible with netstrings. This lets us
use it to directly parse a zeromq message from anyone, and it will work
whether it&#8217;s a TNetString-style nested structure, or just a string with JSON in
it.
<!--l. 433--><p class="noindent" >The end result is a simple specification at <a 
href="http://tnetstrings.org" >http://tnetstrings.org</a> which encodes a
nave parser that anyone can copy to other languages easily. Many other people
implemented the protocol and it looks like you can do it in every language in
about 100 lines of code. Implementing a version with more performance
(since every language needs tricks) seems to take about 500-1000 lines of
code.
<!--l. 440--><p class="noindent" >Mongrel2 now supports either TNetStrings or JSON as defined above, on the fly, and
without any modification to existing handlers. Internally, Mongrel2 uses TNetStrings
to create its internal control port protocol, which makes working with Mongrel2
programatically even easier.
<!--l. 445--><p class="noindent" >To demonstrate this, here&#8217;s the new code for parsing a request in Python:
                                                                  

                                                                  
<!--l. 448--><p class="noindent" ><a 
 id="x8-78001r34"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 34: </span><span  
class="content">                                                                <span 
class="pplri7t-">Parsing TNetStrings Requests In</span>
<span 
class="pplri7t-">Python</span></span></div><!--tex4ht:label?: x8-78001r34 -->
<div class="fancyvrb" id="fancyvrb34">
<a 
 id="x8-78003r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor444"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor445"><span 
class="pcrb7t-x-x-90">mongrel2</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor446"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;tnetstrings</span>
<br class="fancyvrb" /><a 
 id="x8-78005r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-78007r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor447"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor448"><span 
class="pcrb7t-x-x-90">parse</span></span><span 
class="pcrr7t-x-x-90">(msg):</span>
<br class="fancyvrb" /><a 
 id="x8-78009r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender,</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path,</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;msg.split(</span><span 
class="colorbox" id="colorbox449"><span id="textcolor450"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox451"><span id="textcolor452"><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox453"><span id="textcolor454"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor455"><span 
class="pcrb7t-x-x-90">3</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-78011r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;rest</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;tnetstrings.parse(rest)</span>
<br class="fancyvrb" /><a 
 id="x8-78013r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;body,</span><span 
class="pcrr7t-x-x-90">&#x00A0;_</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;tnetstrings.parse(rest)</span>
<br class="fancyvrb" /><a 
 id="x8-78015r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-78017r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor456"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor457"><span 
class="pcrr7t-x-x-90">type</span></span><span 
class="pcrr7t-x-x-90">(headers)</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor458"><span 
class="pcrr7t-x-x-90">is</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor459"><span 
class="pcrr7t-x-x-90">str</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-78019r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;json.loads(headers)</span>
<br class="fancyvrb" /><a 
 id="x8-78021r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-78023r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor460"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;Request(sender,</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path,</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;body)</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 465--><p class="noindent" >Our tests also show that TNetStrings are a good compromise between speed and
ease of parsing. They&#8217;re hard to get wrong in parsing, easy to write out, and faster
than many other protocols out there. The few that are faster are also much, much,
harder to parse and more error prone. In our tests, we&#8217;ve found that TNetStrings in
Python can be faster than Python&#8217;s own pickle format when we use a C
extension.
<!--l. 472--><p class="noindent" >The most important point about TNetStrings, though, is how it opens up Mongrel2
for even more control and automation.
<h4 class="subsectionHead"><span class="titlemark">5.3.8    </span> <a 
 id="x8-790005.3.8"></a>Python Handler API</h4>
<!--l. 477--><p class="noindent" >Instead of building all of this yourself, I&#8217;ve created a Python library that wraps all
this up and makes it easy to use. Each of the other libraries are designed around
the same idea and should have a similar design. To check out how to use
the Python API, we&#8217;ll take a look at each of the demos that are available.
These are the same demos you ran in the previous section to create a sample
deployment.
<!--l. 484--><p class="noindent" >For the Python API, you may want to start by looking at two very small files that should
be able to understand quickly: <span 
class="pcrb7t-">examples/python/mongrel2/request.py </span>and
<span 
class="pcrb7t-">examples/python/mongrel2/handler.py</span>.
<!--l. 489--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.4    </span> <a 
 id="x8-800005.4"></a>Basic Handler Demo</h3>
<!--l. 491--><p class="noindent" >The most basic handler you can write is in the <span 
class="pcrb7t-">examples/http</span><span 
class="pcrb7t-">_0mq/http.py </span>file and it just the
simplest thing possible:<span class="footnote-mark"><a 
href="#fn3x7" id="fn3x7-bk"><sup class="textsuperscript">3</sup></a></span><a 
 id="x8-80001f3"></a>
                                                                  

                                                                  
<!--l. 495--><p class="noindent" ><a 
 id="x8-80002r35"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 35: </span><span  
class="content">                                                                                                          <span 
class="pplri7t-">http.py</span>
<span 
class="pplri7t-">example</span></span></div><!--tex4ht:label?: x8-80002r35 -->
<div class="fancyvrb" id="fancyvrb35">
<a 
 id="x8-80004r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor461"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor462"><span 
class="pcrb7t-x-x-90">mongrel2</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor463"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;handler</span>
<br class="fancyvrb" /><a 
 id="x8-80006r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor464"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor465"><span 
class="pcrb7t-x-x-90">json</span></span>
<br class="fancyvrb" /><a 
 id="x8-80008r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor466"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor467"><span 
class="pcrb7t-x-x-90">uuid</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor468"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;uuid4</span>
<br class="fancyvrb" /><a 
 id="x8-80010r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80012r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor469"><span 
class="pcrr7t-x-x-90">#</span><span 
class="pcrr7t-x-x-90">&#x00A0;ZMQ</span><span 
class="pcrr7t-x-x-90">&#x00A0;2.1.x</span><span 
class="pcrr7t-x-x-90">&#x00A0;broke</span><span 
class="pcrr7t-x-x-90">&#x00A0;how</span><span 
class="pcrr7t-x-x-90">&#x00A0;PUSH/PULL</span><span 
class="pcrr7t-x-x-90">&#x00A0;round-robin</span><span 
class="pcrr7t-x-x-90">&#x00A0;works</span><span 
class="pcrr7t-x-x-90">&#x00A0;so</span><span 
class="pcrr7t-x-x-90">&#x00A0;each</span><span 
class="pcrr7t-x-x-90">&#x00A0;process</span></span>
<br class="fancyvrb" /><a 
 id="x8-80014r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor470"><span 
class="pcrr7t-x-x-90">#</span><span 
class="pcrr7t-x-x-90">&#x00A0;needs</span><span 
class="pcrr7t-x-x-90">&#x00A0;it's</span><span 
class="pcrr7t-x-x-90">&#x00A0;own</span><span 
class="pcrr7t-x-x-90">&#x00A0;id</span><span 
class="pcrr7t-x-x-90">&#x00A0;for</span><span 
class="pcrr7t-x-x-90">&#x00A0;it</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;work</span></span>
<br class="fancyvrb" /><a 
 id="x8-80016r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender_id</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;uuid4().hex</span>
<br class="fancyvrb" /><a 
 id="x8-80018r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80020r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;handler.Connection(sender_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox471"><span id="textcolor472"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox473"><span id="textcolor474"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9997</span></span></span><span 
class="colorbox" id="colorbox475"><span id="textcolor476"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span>
<br class="fancyvrb" /><a 
 id="x8-80022r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox477"><span id="textcolor478"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox479"><span id="textcolor480"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9996</span></span></span><span 
class="colorbox" id="colorbox481"><span id="textcolor482"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-80024r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor483"><span 
class="pcrb7t-x-x-90">while</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor484"><span 
class="pcrr7t-x-x-90">True</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-80026r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor485"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox486"><span id="textcolor487"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox488"><span id="textcolor489"><span 
class="pcrr7t-x-x-90">WAITING</span><span 
class="pcrr7t-x-x-90">&#x00A0;FOR</span><span 
class="pcrr7t-x-x-90">&#x00A0;REQUEST</span></span></span><span 
class="colorbox" id="colorbox490"><span id="textcolor491"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-80028r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80030r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;req</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn.recv()</span>
<br class="fancyvrb" /><a 
 id="x8-80032r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80034r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor492"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.is_disconnect():</span>
<br class="fancyvrb" /><a 
 id="x8-80036r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor493"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox494"><span id="textcolor495"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox496"><span id="textcolor497"><span 
class="pcrr7t-x-x-90">DISCONNECT</span></span></span><span 
class="colorbox" id="colorbox498"><span id="textcolor499"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-80038r18"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor500"><span 
class="pcrb7t-x-x-90">continue</span></span>
<br class="fancyvrb" /><a 
 id="x8-80040r19"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80042r20"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor501"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox502"><span id="textcolor503"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox504"><span id="textcolor505"><span 
class="pcrr7t-x-x-90">killme</span></span></span><span 
class="colorbox" id="colorbox506"><span id="textcolor507"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor508"><span 
class="pcrr7t-x-x-90">None</span></span><span 
class="pcrr7t-x-x-90">):</span>
<br class="fancyvrb" /><a 
 id="x8-80044r21"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor509"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox510"><span id="textcolor511"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox512"><span id="textcolor513"><span 
class="pcrr7t-x-x-90">They</span><span 
class="pcrr7t-x-x-90">&#x00A0;want</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;be</span><span 
class="pcrr7t-x-x-90">&#x00A0;killed.</span></span></span><span 
class="colorbox" id="colorbox514"><span id="textcolor515"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-80046r22"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox516"><span id="textcolor517"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox518"><span id="textcolor519"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-80048r23"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor520"><span 
class="pcrb7t-x-x-90">else</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-80050r24"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox521"><span id="textcolor522"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox523"><span id="textcolor524"><span 
class="pcrr7t-x-x-90">&#x003C;pre&#x003E;</span></span></span><span 
class="colorbox" id="colorbox525"><span id="textcolor526"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox527"><span id="textcolor528"><span 
class="pcrr7t-x-x-90">SENDER:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox529"><span id="textcolor530"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox531"><span id="textcolor532"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox533"><span id="textcolor534"><span 
class="pcrr7t-x-x-90">IDENT:</span></span></span><span 
class="colorbox" id="colorbox535"><span id="textcolor536"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox537"><span id="textcolor538"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox539"><span id="textcolor540"><span 
class="pcrr7t-x-x-90">PATH:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox541"><span id="textcolor542"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox543"><span id="textcolor544"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox545"><span id="textcolor546"><span 
class="pcrr7t-x-x-90">HEADERS:</span></span></span><span 
class="colorbox" id="colorbox547"><span id="textcolor548"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox549"><span id="textcolor550"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox551"><span id="textcolor552"><span 
class="pcrr7t-x-x-90">BODY:</span></span></span><span 
class="colorbox" id="colorbox553"><span id="textcolor554"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox555"><span id="textcolor556"><span 
class="pcrr7t-x-x-90">&#x003C;/pre&#x003E;</span></span></span><span 
class="colorbox" id="colorbox557"><span id="textcolor558"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;(</span>
<br class="fancyvrb" /><a 
 id="x8-80052r25"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.sender,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.path,</span>
<br class="fancyvrb" /><a 
 id="x8-80054r26"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;json.dumps(req.headers),</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.body)</span>
<br class="fancyvrb" /><a 
 id="x8-80056r27"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80058r28"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor559"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span>
<br class="fancyvrb" /><a 
 id="x8-80060r29"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80062r30"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn.reply_http(req,</span><span 
class="pcrr7t-x-x-90">&#x00A0;response)</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 531--><p class="noindent" >All this code does is print back a simple little dump of what it received, and it&#8217;s not
even a valid HTML document. Let&#8217;s walk through everything that&#8217;s going
on:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x8-80064x1">Import  the  <span 
class="pcrro7t-">handler </span>module  from  <span 
class="pcrro7t-">mongrel2 </span>and  <span 
class="pcrro7t-">json</span>.  The  <span 
class="pcrro7t-">json</span>
     module is really only used for logging.
     </li>
     <li 
  class="enumerate" id="x8-80066x2">Establish the UUID for our handler, and create a connection. It&#8217;s not <span 
class="pplri7t-">really</span>
     a connection but more of a &#8220;virtual circuit&#8221; that you can just pretend is a
     connection. It&#8217;s using all ZeroMQ and the protocol we just described to
     create a simple API to use.
     </li>
     <li 
  class="enumerate" id="x8-80068x3">Go into a while loop forever and recv request objects off the connection.
     </li>
     <li 
  class="enumerate" id="x8-80070x4">One type of special message we can get from Mongrel2 is a &#8220;disconnect&#8221;
     message, which tells you that one of the listeners you tried to talk to was
     closed. You should either ignore those and read another, or update any
     internal state you may have. They can come asynchronously, and for the
     most part you can ignore them unless you need to keep them open as in,
     say, a chat application or streaming.
     </li>
     <li 
  class="enumerate" id="x8-80072x5">Craft the reply you&#8217;re going to send back, which is just a dump of what
     you received.
     </li>
     <li 
  class="enumerate" id="x8-80074x6">Send  this  reply  back  to  Mongrel2.  Notice  the  subtle  difference  where
     you include the <span 
class="pplri7t-">req </span>object as part of how you reply? This is the major
     difference between this API and more traditional request/response APIs
     in that you need the request you are responding to so that it knows where
     to send things. In a normal socket-based server this is just assumed to be
     the socket you&#8217;re talking about.</li></ol>
<!--l. 552--><p class="noindent" >This is all you need at first to do simple HTTP handlers. In reality, the <span 
class="pcrro7t-">reply</span><span 
class="pcrro7t-">_http</span>
method is just syntactic sugar on crafting a decent HTTP response. Here&#8217;s the actual
method that is crafting these replies:
                                                                  

                                                                  
<!--l. 555--><p class="noindent" ><a 
 id="x8-80075r36"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 36: </span><span  
class="content">                                                                               <span 
class="pplri7t-">HTTP Response Python</span>
<span 
class="pplri7t-">Code</span></span></div><!--tex4ht:label?: x8-80075r36 -->
<div class="fancyvrb" id="fancyvrb36">
<a 
 id="x8-80077r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor560"><span 
class="pcrb7t-x-x-90">def</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor561"><span 
class="pcrb7t-x-x-90">http_response</span></span><span 
class="pcrr7t-x-x-90">(body,</span><span 
class="pcrr7t-x-x-90">&#x00A0;code,</span><span 
class="pcrr7t-x-x-90">&#x00A0;status,</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers):</span>
<br class="fancyvrb" /><a 
 id="x8-80079r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;payload</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span><span 
class="colorbox" id="colorbox562"><span id="textcolor563"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox564"><span id="textcolor565"><span 
class="pcrr7t-x-x-90">code</span></span></span><span 
class="colorbox" id="colorbox566"><span id="textcolor567"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;code,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox568"><span id="textcolor569"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox570"><span id="textcolor571"><span 
class="pcrr7t-x-x-90">status</span></span></span><span 
class="colorbox" id="colorbox572"><span id="textcolor573"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;status,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox574"><span id="textcolor575"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox576"><span id="textcolor577"><span 
class="pcrr7t-x-x-90">body</span></span></span><span 
class="colorbox" id="colorbox578"><span id="textcolor579"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;body}</span>
<br class="fancyvrb" /><a 
 id="x8-80081r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers[</span><span 
class="colorbox" id="colorbox580"><span id="textcolor581"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox582"><span id="textcolor583"><span 
class="pcrr7t-x-x-90">Content-Length</span></span></span><span 
class="colorbox" id="colorbox584"><span id="textcolor585"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">]</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor586"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">(body)</span>
<br class="fancyvrb" /><a 
 id="x8-80083r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;payload[</span><span 
class="colorbox" id="colorbox587"><span id="textcolor588"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox589"><span id="textcolor590"><span 
class="pcrr7t-x-x-90">headers</span></span></span><span 
class="colorbox" id="colorbox591"><span id="textcolor592"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">]</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox593"><span id="textcolor594"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox595"><span id="textcolor596"><span 
class="pcrr7t-x-x-90">\r</span></span></span><span 
class="colorbox" id="colorbox597"><span id="textcolor598"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox599"><span id="textcolor600"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">.join(</span><span 
class="colorbox" id="colorbox601"><span id="textcolor602"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox603"><span id="textcolor604"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox605"><span id="textcolor606"><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox607"><span id="textcolor608"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox609"><span id="textcolor610"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;(k,v)</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor611"><span 
class="pcrb7t-x-x-90">for</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;k,v</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor612"><span 
class="pcrr7t-x-x-90">in</span></span>
<br class="fancyvrb" /><a 
 id="x8-80085r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers.items())</span>
<br class="fancyvrb" /><a 
 id="x8-80087r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-80089r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor613"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;HTTP_FORMAT</span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;payload</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 568--><p class="noindent" >Which is then used by <span 
class="pcrro7t-">Connection.reply</span><span 
class="pcrro7t-">_http </span>and <span 
class="pcrro7t-">Connection.deliver</span><span 
class="pcrro7t-">_http</span>
to send an actual HTTP response. That means all this is doing is creating
the raw bytes you want to go to the real browser, and how it&#8217;s delivered is
irrelevant. For example, the <span 
class="pcrro7t-">deliver</span><span 
class="pcrro7t-">_http </span>method means that, yes, you
can have one handler send a single response to target <span 
class="pplri7t-">multiple </span>browsers at
once.
<h3 class="sectionHead"><span class="titlemark">5.5    </span> <a 
 id="x8-810005.5"></a>Async File Upload Demo</h3>
<!--l. 579--><p class="noindent" >Mongrel2 uses an asynchronous method of doing uploads that helps you avoid
receiving files you either can&#8217;t accept or shouldn&#8217;t accept. It does this by sending
your handler an initial message with just the headers, streaming the file to disk, and
then a final message so you can read the resulting file. If you don&#8217;t want the upload,
then you can send a kill message (a 0 length message) and the connection closes, and
the file never lands.
<!--l. 586--><p class="noindent" >The upload mechanism works entirely on content length, and whether the file is
larger than the <span 
class="pcrro7t-">limits.content</span><span 
class="pcrro7t-">_length</span>. This means if you don&#8217;t want to deal
with this for most form uploads, then just set <span 
class="pcrro7t-">limits.content</span><span 
class="pcrro7t-">_length </span>high
enough and you won&#8217;t have to.
<!--l. 591--><p class="noindent" >However, if you want to handle file uploads or large requests, then you
add the setting <span 
class="pcrro7t-">upload.temp</span><span 
class="pcrro7t-">_store </span>to a <span 
class="pcrro7t-">mkstemp </span>compatible path like
<span 
class="pcrb7t-">/tmp/mongrel2.upload.XXXXXX </span>with the XXXXXX chars being replaced with
random characters. It doesn&#8217;t have to /tmp either, and can be any store you want,
network disk, anything.
<!--l. 597--><p class="noindent" >Here&#8217;s an example handler in <span 
class="pcrb7t-">examples/http</span><span 
class="pcrb7t-">_0mq/upload.py </span>that shows you
how to do it:
                                                                  

                                                                  
<!--l. 600--><p class="noindent" ><a 
 id="x8-81001r37"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 37: </span><span  
class="content">                                                                                               <span 
class="pplri7t-">Async Upload</span>
<span 
class="pplri7t-">Example</span></span></div><!--tex4ht:label?: x8-81001r37 -->
<div class="fancyvrb" id="fancyvrb37">
<a 
 id="x8-81003r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor614"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor615"><span 
class="pcrb7t-x-x-90">mongrel2</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor616"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;handler</span>
<br class="fancyvrb" /><a 
 id="x8-81005r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor617"><span 
class="pcrb7t-x-x-90">try</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-81007r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor618"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor619"><span 
class="pcrb7t-x-x-90">json</span></span>
<br class="fancyvrb" /><a 
 id="x8-81009r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor620"><span 
class="pcrb7t-x-x-90">except</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-81011r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor621"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor622"><span 
class="pcrb7t-x-x-90">simplejson</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor623"><span 
class="pcrb7t-x-x-90">as</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor624"><span 
class="pcrb7t-x-x-90">json</span></span>
<br class="fancyvrb" /><a 
 id="x8-81013r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81015r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor625"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor626"><span 
class="pcrb7t-x-x-90">hashlib</span></span>
<br class="fancyvrb" /><a 
 id="x8-81017r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81019r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender_id</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox627"><span id="textcolor628"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox629"><span id="textcolor630"><span 
class="pcrr7t-x-x-90">82209006-86FF-4982-B5EA-D1E29E55D481</span></span></span><span 
class="colorbox" id="colorbox631"><span id="textcolor632"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-81021r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81023r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;handler.Connection(sender_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox633"><span id="textcolor634"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox635"><span id="textcolor636"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9997</span></span></span><span 
class="colorbox" id="colorbox637"><span id="textcolor638"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span>
<br class="fancyvrb" /><a 
 id="x8-81025r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox639"><span id="textcolor640"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox641"><span id="textcolor642"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9996</span></span></span><span 
class="colorbox" id="colorbox643"><span id="textcolor644"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-81027r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor645"><span 
class="pcrb7t-x-x-90">while</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor646"><span 
class="pcrr7t-x-x-90">True</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-81029r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor647"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox648"><span id="textcolor649"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox650"><span id="textcolor651"><span 
class="pcrr7t-x-x-90">WAITING</span><span 
class="pcrr7t-x-x-90">&#x00A0;FOR</span><span 
class="pcrr7t-x-x-90">&#x00A0;REQUEST</span></span></span><span 
class="colorbox" id="colorbox652"><span id="textcolor653"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-81031r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81033r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;req</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn.recv()</span>
<br class="fancyvrb" /><a 
 id="x8-81035r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81037r18"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor654"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.is_disconnect():</span>
<br class="fancyvrb" /><a 
 id="x8-81039r19"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor655"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox656"><span id="textcolor657"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox658"><span id="textcolor659"><span 
class="pcrr7t-x-x-90">DISCONNECT</span></span></span><span 
class="colorbox" id="colorbox660"><span id="textcolor661"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-81041r20"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor662"><span 
class="pcrb7t-x-x-90">continue</span></span>
<br class="fancyvrb" /><a 
 id="x8-81043r21"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81045r22"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor663"><span 
class="pcrb7t-x-x-90">elif</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox664"><span id="textcolor665"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox666"><span id="textcolor667"><span 
class="pcrr7t-x-x-90">x-mongrel2-upload-done</span></span></span><span 
class="colorbox" id="colorbox668"><span id="textcolor669"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor670"><span 
class="pcrr7t-x-x-90">None</span></span><span 
class="pcrr7t-x-x-90">):</span>
<br class="fancyvrb" /><a 
 id="x8-81047r23"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;expected</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox671"><span id="textcolor672"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox673"><span id="textcolor674"><span 
class="pcrr7t-x-x-90">x-mongrel2-upload-start</span></span></span><span 
class="colorbox" id="colorbox675"><span id="textcolor676"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox677"><span id="textcolor678"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox679"><span id="textcolor680"><span 
class="pcrr7t-x-x-90">BAD</span></span></span><span 
class="colorbox" id="colorbox681"><span id="textcolor682"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-81049r24"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;upload</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox683"><span id="textcolor684"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox685"><span id="textcolor686"><span 
class="pcrr7t-x-x-90">x-mongrel2-upload-done</span></span></span><span 
class="colorbox" id="colorbox687"><span id="textcolor688"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor689"><span 
class="pcrr7t-x-x-90">None</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-81051r25"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81053r26"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor690"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;expected</span><span 
class="pcrr7t-x-x-90">&#x00A0;!=</span><span 
class="pcrr7t-x-x-90">&#x00A0;upload:</span>
<br class="fancyvrb" /><a 
 id="x8-81055r27"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor691"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox692"><span id="textcolor693"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox694"><span id="textcolor695"><span 
class="pcrr7t-x-x-90">GOT</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;WRONG</span><span 
class="pcrr7t-x-x-90">&#x00A0;TARGET</span><span 
class="pcrr7t-x-x-90">&#x00A0;FILE:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox696"><span id="textcolor697"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;expected,</span><span 
class="pcrr7t-x-x-90">&#x00A0;upload</span>
<br class="fancyvrb" /><a 
 id="x8-81057r28"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor698"><span 
class="pcrb7t-x-x-90">continue</span></span>
<br class="fancyvrb" /><a 
 id="x8-81059r29"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81061r30"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;body</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor699"><span 
class="pcrr7t-x-x-90">open</span></span><span 
class="pcrr7t-x-x-90">(upload,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox700"><span id="textcolor701"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox702"><span id="textcolor703"><span 
class="pcrr7t-x-x-90">r</span></span></span><span 
class="colorbox" id="colorbox704"><span id="textcolor705"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">).read()</span>
<br class="fancyvrb" /><a 
 id="x8-81063r31"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor706"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox707"><span id="textcolor708"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox709"><span id="textcolor710"><span 
class="pcrr7t-x-x-90">UPLOAD</span><span 
class="pcrr7t-x-x-90">&#x00A0;DONE:</span><span 
class="pcrr7t-x-x-90">&#x00A0;BODY</span><span 
class="pcrr7t-x-x-90">&#x00A0;IS</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox711"><span id="textcolor712"><span 
class="pcrr7t-x-x-90">%d</span></span></span><span 
class="colorbox" id="colorbox713"><span id="textcolor714"><span 
class="pcrr7t-x-x-90">&#x00A0;long,</span><span 
class="pcrr7t-x-x-90">&#x00A0;content</span><span 
class="pcrr7t-x-x-90">&#x00A0;length</span><span 
class="pcrr7t-x-x-90">&#x00A0;is</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox715"><span id="textcolor716"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox717"><span id="textcolor718"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;(</span>
<br class="fancyvrb" /><a 
 id="x8-81065r32"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor719"><span 
class="pcrr7t-x-x-90">len</span></span><span 
class="pcrr7t-x-x-90">(body),</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers[</span><span 
class="colorbox" id="colorbox720"><span id="textcolor721"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox722"><span id="textcolor723"><span 
class="pcrr7t-x-x-90">content-length</span></span></span><span 
class="colorbox" id="colorbox724"><span id="textcolor725"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">])</span>
<br class="fancyvrb" /><a 
 id="x8-81067r33"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81069r34"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox726"><span id="textcolor727"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox728"><span id="textcolor729"><span 
class="pcrr7t-x-x-90">UPLOAD</span><span 
class="pcrr7t-x-x-90">&#x00A0;GOOD:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox730"><span id="textcolor731"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox732"><span id="textcolor733"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;hashlib.md5(body).hexdigest()</span>
<br class="fancyvrb" /><a 
 id="x8-81071r35"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81073r36"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor734"><span 
class="pcrb7t-x-x-90">elif</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox735"><span id="textcolor736"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox737"><span id="textcolor738"><span 
class="pcrr7t-x-x-90">x-mongrel2-upload-start</span></span></span><span 
class="colorbox" id="colorbox739"><span id="textcolor740"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor741"><span 
class="pcrr7t-x-x-90">None</span></span><span 
class="pcrr7t-x-x-90">):</span>
<br class="fancyvrb" /><a 
 id="x8-81075r37"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor742"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox743"><span id="textcolor744"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox745"><span id="textcolor746"><span 
class="pcrr7t-x-x-90">UPLOAD</span><span 
class="pcrr7t-x-x-90">&#x00A0;starting,</span><span 
class="pcrr7t-x-x-90">&#x00A0;don</span></span></span><span 
class="colorbox" id="colorbox747"><span id="textcolor748"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox749"><span id="textcolor750"><span 
class="pcrr7t-x-x-90">t</span><span 
class="pcrr7t-x-x-90">&#x00A0;reply</span><span 
class="pcrr7t-x-x-90">&#x00A0;yet.</span></span></span><span 
class="colorbox" id="colorbox751"><span id="textcolor752"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-81077r38"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor753"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox754"><span id="textcolor755"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox756"><span id="textcolor757"><span 
class="pcrr7t-x-x-90">Will</span><span 
class="pcrr7t-x-x-90">&#x00A0;read</span><span 
class="pcrr7t-x-x-90">&#x00A0;file</span><span 
class="pcrr7t-x-x-90">&#x00A0;from</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox758"><span id="textcolor759"><span 
class="pcrr7t-x-x-90">%s</span></span></span><span 
class="colorbox" id="colorbox760"><span id="textcolor761"><span 
class="pcrr7t-x-x-90">.</span></span></span><span 
class="colorbox" id="colorbox762"><span id="textcolor763"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers.get(</span><span 
class="colorbox" id="colorbox764"><span id="textcolor765"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox766"><span id="textcolor767"><span 
class="pcrr7t-x-x-90">x-mongrel2-upload-start</span></span></span><span 
class="colorbox" id="colorbox768"><span id="textcolor769"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor770"><span 
class="pcrr7t-x-x-90">None</span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-81079r39"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor771"><span 
class="pcrb7t-x-x-90">continue</span></span>
<br class="fancyvrb" /><a 
 id="x8-81081r40"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81083r41"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor772"><span 
class="pcrb7t-x-x-90">else</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-81085r42"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox773"><span id="textcolor774"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox775"><span id="textcolor776"><span 
class="pcrr7t-x-x-90">&#x003C;pre&#x003E;</span></span></span><span 
class="colorbox" id="colorbox777"><span id="textcolor778"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox779"><span id="textcolor780"><span 
class="pcrr7t-x-x-90">SENDER:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox781"><span id="textcolor782"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox783"><span id="textcolor784"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox785"><span id="textcolor786"><span 
class="pcrr7t-x-x-90">IDENT:</span></span></span><span 
class="colorbox" id="colorbox787"><span id="textcolor788"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox789"><span id="textcolor790"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox791"><span id="textcolor792"><span 
class="pcrr7t-x-x-90">PATH:</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span></span><span 
class="colorbox" id="colorbox793"><span id="textcolor794"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox795"><span id="textcolor796"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox797"><span id="textcolor798"><span 
class="pcrr7t-x-x-90">HEADERS:</span></span></span><span 
class="colorbox" id="colorbox799"><span id="textcolor800"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox801"><span id="textcolor802"><span 
class="pcrr7t-x-x-90">\n</span></span></span><span 
class="colorbox" id="colorbox803"><span id="textcolor804"><span 
class="pcrr7t-x-x-90">BODY:</span></span></span><span 
class="colorbox" id="colorbox805"><span id="textcolor806"><span 
class="pcrr7t-x-x-90">%r</span></span></span><span 
class="colorbox" id="colorbox807"><span id="textcolor808"><span 
class="pcrr7t-x-x-90">&#x003C;/pre&#x003E;</span></span></span><span 
class="colorbox" id="colorbox809"><span id="textcolor810"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">&#x00A0;%</span><span 
class="pcrr7t-x-x-90">&#x00A0;(</span>
<br class="fancyvrb" /><a 
 id="x8-81087r43"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.sender,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.conn_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.path,</span>
<br class="fancyvrb" /><a 
 id="x8-81089r44"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;json.dumps(req.headers),</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.body)</span>
<br class="fancyvrb" /><a 
 id="x8-81091r45"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
                                                                  

                                                                  
<br class="fancyvrb" /><a 
 id="x8-81093r46"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor811"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;response</span>
<br class="fancyvrb" /><a 
 id="x8-81095r47"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-81097r48"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;conn.reply_http(req,</span><span 
class="pcrr7t-x-x-90">&#x00A0;response)</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 654--><p class="noindent" >You  can  test  this  with  something  like
<span class="obeylines-h"><span class="verb"><span 
class="pcrr7t-">curl</span><span 
class="pcrr7t-">&#x00A0;-T</span><span 
class="pcrr7t-">&#x00A0;tests/config.sqlite</span><span 
class="pcrr7t-">&#x00A0;http://localhost:6767/handlertest</span></span></span>
to upload a big file.
<!--l. 657--><p class="noindent" >What&#8217;s happening is the following process:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x8-81099x1">Mongrel2 receives a request from a browser (or curl in this case) that is
     greater than <span 
class="pcrro7t-">limits.content</span><span 
class="pcrro7t-">_length </span>in size. It actually doesn&#8217;t read
     all of it yet, only about 2k.
     </li>
     <li 
  class="enumerate" id="x8-81101x2">Mongrel2 looks up the <span 
class="pcrro7t-">upload.temp</span><span 
class="pcrro7t-">_store </span>setting and makes a temp
     file there to write the contents. If you don&#8217;t have this setting then it aborts
     and returns an error to the browser.
     </li>
     <li 
  class="enumerate" id="x8-81103x3">Mongrel2  sees  that  the  request  is  for  a  Handler,  so  it  crafts  an  initial
     request message. This request message has all the original headers, plus
     a  <span 
class="pcrro7t-">X-Mongrel2-Upload-Start </span>header  with  the  path  of  the  expected
     tmpfile you will read later.
     </li>
     <li 
  class="enumerate" id="x8-81105x4">Your handler receives this message, which has no actual content, but the
     original content length, all the headers, and this new header to indicate
     an upload is starting.
     </li>
     <li 
  class="enumerate" id="x8-81107x5">At this point, your handler can decide to kill the connection by simply
     responding with a kill message, or even with a valid HTTP error reponse
     then a kill message.
     </li>
     <li 
  class="enumerate" id="x8-81109x6">Otherwise   your   handler   does   nothing,   and   Mongrel2   is   already
     streaming the file into the designated tmpfile for this upload.
     </li>
     <li 
  class="enumerate" id="x8-81111x7">When  the  upload  is  finally  saved  to  the  file,  it  <span 
class="pplri7t-">adds  </span>a  new  header  of
     <span 
class="pcrro7t-">X-Mongrel2-Upload-Done </span>set  to  the  same  file  as  the  first  header.
     Remember that <span 
class="pplri7t-">both </span>headers are in this final request.
     </li>
     <li 
  class="enumerate" id="x8-81113x8">Your   handler   then   gets   this   final   request   message   that   has   both
     the   <span 
class="pcrro7t-">X-Mongrel2-Upload-Start </span>and   <span 
class="pcrro7t-">X-Mongrel2-Upload-Done</span>
     headers, which you can then use to read the upload contents. You should
     also make sure the headers match to prevent someone forging completed
     uploads.</li></ol>
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 670--><p class="noindent" ><a 
 id="x8-81114r10"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Note 10: </span><span  
class="content">                                                                                             <span 
class="pplri7t-">Watch The chroot</span>
<span 
class="pplri7t-">Too</span></span></div><!--tex4ht:label?: x8-81114r10 -->
     <div class="quote">
     <!--l. 671--><p class="indent" >   Remember, when you run Mongrel2 it will store the file relative
     to  its  <span 
class="pcrro7t-">chroot </span>setting.  In  testing  you  probably  aren&#8217;t  running
     Mongrel2  as  root  so  it  works  fine.  You  just  then  have  to  make
     sure  that  your  handler  know  to  look  for  the  file  in  the  same
     place. So if you have <span 
class="pcrb7t-">/var/www/mongrel2.org </span>for your <span 
class="pcrro7t-">chroot</span>
     and  <span 
class="pcrb7t-">/uploads/file.XXXXXX </span>then  the  actual  file  will  be  in
     <span 
class="pcrb7t-">/var/www/mongrel2.org/uploads/file.XXXXXX</span>. The good
     thing is you can read the config database in your handlers and find
     out all this information as well. </div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<h3 class="sectionHead"><span class="titlemark">5.6    </span> <a 
 id="x8-820005.6"></a>MP3 Streaming Demo</h3>
<!--l. 680--><p class="noindent" >The next example is a very simple and, well, kind of poorly implemented MP3
streaming demo that uses the ICY protocol. ICY is a really lame protocol that was
obviously designed before HTTP was totally baked and probably by people
who don&#8217;t really get HTTP. It works in an odd way of having meta-data
sent at specific sized intervals so the client can display an update to the
meta-data.
<!--l. 687--><p class="noindent" >The mp3streamer demo creates a streaming system by having a thread that receives
requests for connections, and then another thread that sends the current data to all
currently connected clients. Rather than go through all the code, you can take a look
at the main file and see how simple it is once you get the streaming thread
right:
                                                                  

                                                                  
<!--l. 694--><p class="noindent" ><a 
 id="x8-82001r38"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 38: </span><span  
class="content">                                                                                            <span 
class="pplri7t-">Base mp3stream</span>
<span 
class="pplri7t-">Code</span></span></div><!--tex4ht:label?: x8-82001r38 -->
<div class="fancyvrb" id="fancyvrb38">
<a 
 id="x8-82003r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor812"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor813"><span 
class="pcrb7t-x-x-90">mp3stream</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor814"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;ConnectState,</span><span 
class="pcrr7t-x-x-90">&#x00A0;Streamer</span>
<br class="fancyvrb" /><a 
 id="x8-82005r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor815"><span 
class="pcrb7t-x-x-90">from</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor816"><span 
class="pcrb7t-x-x-90">mongrel2</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor817"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;handler</span>
<br class="fancyvrb" /><a 
 id="x8-82007r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor818"><span 
class="pcrb7t-x-x-90">import</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor819"><span 
class="pcrb7t-x-x-90">glob</span></span>
<br class="fancyvrb" /><a 
 id="x8-82009r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82011r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82013r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender_id</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox820"><span id="textcolor821"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox822"><span id="textcolor823"><span 
class="pcrr7t-x-x-90">9703b4dd-227a-45c4-b7a1-ef62d97962b2</span></span></span><span 
class="colorbox" id="colorbox824"><span id="textcolor825"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-82015r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82017r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONN</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;handler.Connection(sender_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox826"><span id="textcolor827"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox828"><span id="textcolor829"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9995</span></span></span><span 
class="colorbox" id="colorbox830"><span id="textcolor831"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span>
<br class="fancyvrb" /><a 
 id="x8-82019r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox832"><span id="textcolor833"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox834"><span id="textcolor835"><span 
class="pcrr7t-x-x-90">tcp://127.0.0.1:9994</span></span></span><span 
class="colorbox" id="colorbox836"><span id="textcolor837"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-82021r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82023r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82025r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STREAM_NAME</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox838"><span id="textcolor839"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox840"><span id="textcolor841"><span 
class="pcrr7t-x-x-90">Mongrel2</span><span 
class="pcrr7t-x-x-90">&#x00A0;Radio</span></span></span><span 
class="colorbox" id="colorbox842"><span id="textcolor843"><span 
class="pcrr7t-x-x-90">"</span></span></span>
<br class="fancyvrb" /><a 
 id="x8-82027r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82029r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;MP3_FILES</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;glob.glob(</span><span 
class="colorbox" id="colorbox844"><span id="textcolor845"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox846"><span id="textcolor847"><span 
class="pcrr7t-x-x-90">&#x22C6;.mp3</span></span></span><span 
class="colorbox" id="colorbox848"><span id="textcolor849"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-82031r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82033r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor850"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox851"><span id="textcolor852"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox853"><span id="textcolor854"><span 
class="pcrr7t-x-x-90">PLAYING:</span></span></span><span 
class="colorbox" id="colorbox855"><span id="textcolor856"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;MP3_FILES</span>
<br class="fancyvrb" /><a 
 id="x8-82035r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82037r18"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;CHUNK_SIZE</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor857"><span 
class="pcrb7t-x-x-90">8</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor858"><span 
class="pcrb7t-x-x-90">1024</span></span>
<br class="fancyvrb" /><a 
 id="x8-82039r19"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82041r20"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;ConnectState()</span>
<br class="fancyvrb" /><a 
 id="x8-82043r21"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82045r22"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STREAMER</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;Streamer(MP3_FILES,</span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE,</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONN,</span><span 
class="pcrr7t-x-x-90">&#x00A0;CHUNK_SIZE,</span><span 
class="pcrr7t-x-x-90">&#x00A0;sender_id)</span>
<br class="fancyvrb" /><a 
 id="x8-82047r23"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STREAMER.start()</span>
<br class="fancyvrb" /><a 
 id="x8-82049r24"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82051r25"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;HEADERS</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox859"><span id="textcolor860"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox861"><span id="textcolor862"><span 
class="pcrr7t-x-x-90">icy-metaint</span></span></span><span 
class="colorbox" id="colorbox863"><span id="textcolor864"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;CHUNK_SIZE,</span>
<br class="fancyvrb" /><a 
 id="x8-82053r26"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox865"><span id="textcolor866"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="colorbox" id="colorbox867"><span id="textcolor868"><span 
class="pcrr7t-x-x-90">icy-name</span></span></span><span 
class="colorbox" id="colorbox869"><span id="textcolor870"><span 
class="pcrr7t-x-x-90">'</span></span></span><span 
class="pcrr7t-x-x-90">:</span><span 
class="pcrr7t-x-x-90">&#x00A0;STREAM_NAME}</span>
<br class="fancyvrb" /><a 
 id="x8-82055r27"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82057r28"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82059r29"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor871"><span 
class="pcrb7t-x-x-90">while</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor872"><span 
class="pcrr7t-x-x-90">True</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-82061r30"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;req</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONN.recv()</span>
<br class="fancyvrb" /><a 
 id="x8-82063r31"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82065r32"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor873"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;req.is_disconnect():</span>
<br class="fancyvrb" /><a 
 id="x8-82067r33"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor874"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox875"><span id="textcolor876"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox877"><span id="textcolor878"><span 
class="pcrr7t-x-x-90">DISCONNECT</span></span></span><span 
class="colorbox" id="colorbox879"><span id="textcolor880"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.body,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.conn_id</span>
<br class="fancyvrb" /><a 
 id="x8-82069r34"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE.remove(req)</span>
<br class="fancyvrb" /><a 
 id="x8-82071r35"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor881"><span 
class="pcrb7t-x-x-90">else</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-82073r36"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor882"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox883"><span id="textcolor884"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox885"><span id="textcolor886"><span 
class="pcrr7t-x-x-90">REQUEST</span></span></span><span 
class="colorbox" id="colorbox887"><span id="textcolor888"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.headers,</span><span 
class="pcrr7t-x-x-90">&#x00A0;req.body</span>
<br class="fancyvrb" /><a 
 id="x8-82075r37"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-82077r38"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor889"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE.count()</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x003E;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor890"><span 
class="pcrb7t-x-x-90">20</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-82079r39"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor891"><span 
class="pcrb7t-x-x-90">print</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox892"><span id="textcolor893"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox894"><span id="textcolor895"><span 
class="pcrr7t-x-x-90">TOO</span><span 
class="pcrr7t-x-x-90">&#x00A0;MANY</span></span></span><span 
class="colorbox" id="colorbox896"><span id="textcolor897"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE.count()</span>
<br class="fancyvrb" /><a 
 id="x8-82081r40"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONN.reply_http(req,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox898"><span id="textcolor899"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox900"><span id="textcolor901"><span 
class="pcrr7t-x-x-90">Too</span><span 
class="pcrr7t-x-x-90">&#x00A0;Many</span><span 
class="pcrr7t-x-x-90">&#x00A0;Connected.</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Try</span><span 
class="pcrr7t-x-x-90">&#x00A0;Later.</span></span></span><span 
class="colorbox" id="colorbox902"><span id="textcolor903"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">)</span>
<br class="fancyvrb" /><a 
 id="x8-82083r41"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor904"><span 
class="pcrb7t-x-x-90">else</span></span><span 
class="pcrr7t-x-x-90">:</span>
<br class="fancyvrb" /><a 
 id="x8-82085r42"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;STATE.add(req)</span>
<br class="fancyvrb" /><a 
 id="x8-82087r43"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONN.reply_http(req,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox905"><span id="textcolor906"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox907"><span id="textcolor908"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;headers=HEADERS)</span>
</div>
                                                                  

                                                                  
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 743--><p class="noindent" >Walking through this example is fairly easy, assuming you just trust that the
streaming thread stuff works:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x8-82089x1">Starts off just like the handler test.
     </li>
     <li 
  class="enumerate" id="x8-82091x2">We figure out what .mp3 files are in the current directory.
     </li>
     <li 
  class="enumerate" id="x8-82093x3">Establish  a  data  chunk  size  of  5k  for  the  ICY  protocol  and  make  a
     ConnectState  and  Streamer  from  that.  These  are  the  streaming  thread
     things found in <span 
class="pcrb7t-">mp3stream.py </span>in the same directory.
     </li>
     <li 
  class="enumerate" id="x8-82095x4">We then loop forever, accepting requests.
     </li>
     <li 
  class="enumerate" id="x8-82097x5">Unlike the handler, we want to remove disconnected clients, so we take
     them out of the STATE when we are notified.
     </li>
     <li 
  class="enumerate" id="x8-82099x6">If we have too many connected clients, we reply with a failure.
     </li>
     <li 
  class="enumerate" id="x8-82101x7">Otherwise,  we  add  them  to  the  STATE  and  then  send  the  initial  ICY
     protocol header to get things going.</li></ol>
<!--l. 762--><p class="noindent" >That is the base of it, and if you point mplayer at it (which is the only player that
works, really) you should hear it play:
<div class="fancyvrb" id="fancyvrb39">
<a 
 id="x8-82103r1"></a><span 
class="pcrr7t-">&#x00A0;</span><span 
class="pcrr7t-">&#x00A0;mplayer</span><span 
class="pcrr7t-">&#x00A0;http://localhost:6767/mp3stream</span>
</div>
<!--l. 769--><p class="noindent" >That is, assuming you put some mp3 files into the directory and started the handler
again.
<!--l. 772--><p class="noindent" >For more on how the actual state and the protocol works, go look at mp3stream.py.
Explaining it is far outside the scope of this manual, but the key points to realize are
that this is one thread that&#8217;s targetting randomly connected clients with a single
message to the Mongrel2 server and streaming it.
<h3 class="sectionHead"><span class="titlemark">5.7    </span> <a 
 id="x8-830005.7"></a>Chat Demo</h3>
                                                                  

                                                                  
<!--l. 781--><p class="noindent" >The chat demo is the most involved demonstration, and I&#8217;m kind of getting
tired of leading you by the hand, so you go read the code. Here&#8217;s where to
look:
     <dl class="description"><dt class="description">
<span 
class="pplb7t-">JavaScript</span> </dt><dd 
class="description">Look  at  <span 
class="pcrb7t-">/examples/chat/static/&#x22C6;.js </span>for  the  goodies.  The
     key is to see how <span 
class="pcrb7t-">chat.js </span>works with the JSSocket stuff, and then look
     at how I did <span 
class="pcrb7t-">app.js </span>using <span 
class="pcrb7t-">fsm.js</span>.
     </dd><dt class="description">
<span 
class="pplb7t-">Python</span> </dt><dd 
class="description">Look  at  the  <span 
class="pcrb7t-">/examples/chat/chat.py </span>file  to  see  how  the  chat
     states are maintained and how messages are sent around.
     </dd><dt class="description">
<span 
class="pplb7t-">config</span> </dt><dd 
class="description">The configuration you created in the last chapter actually works with
     the demo, and if you&#8217;ve been following along you should have tested it.</dd></dl>
<!--l. 796--><p class="noindent" >Hopefully, you can figure it out from the code, but if not, let me know.
<!--l. 799--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.8    </span> <a 
 id="x8-840005.8"></a>Writing A Filter (BETA)</h3>
<!--l. 801--><p class="noindent" >In Mongrel2 v1.8.0 there was a new addition of the Filter system, which lets you
intercept the Mongrel2 state machine and fully control how it operates. It&#8217;s still a
very new feature, but there&#8217;s a simple piece of demo code you can look at to see how
they work. You should also check out how to configure them in the Managing
section.
<!--l. 807--><p class="noindent" >Let&#8217;s just take a look at the code to the <span 
class="pcrb7t-">tools/filters/null.c </span>filter.
                                                                  

                                                                  
<!--l. 811--><p class="noindent" ><a 
 id="x8-84001r39"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 39: </span><span  
class="content">                                                                                               <span 
class="pplri7t-">The Basic null</span>
<span 
class="pplri7t-">Filter</span></span></div><!--tex4ht:label?: x8-84001r39 -->
<div class="fancyvrb" id="fancyvrb40">
<a 
 id="x8-84003r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor909"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor910"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;filter.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-84005r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor911"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor912"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;dbg.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-84007r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor913"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor914"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;tnetstrings.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-84009r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84011r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;StateEvent</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor915"><span 
class="pcrb7t-x-x-90">filter_transition</span></span><span 
class="pcrr7t-x-x-90">(StateEvent</span><span 
class="pcrr7t-x-x-90">&#x00A0;state,</span><span 
class="pcrr7t-x-x-90">&#x00A0;Connection</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;conn,</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;config)</span>
<br class="fancyvrb" /><a 
 id="x8-84013r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-84015r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor916"><span 
class="pcrb7t-x-x-90">size_t</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;len</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor917"><span 
class="pcrb7t-x-x-90">0</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-84017r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor918"><span 
class="pcrb7t-x-x-90">char</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;data</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_render(config,</span><span 
class="pcrr7t-x-x-90">&#x00A0;&amp;len);</span>
<br class="fancyvrb" /><a 
 id="x8-84019r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84021r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor919"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">(data</span><span 
class="pcrr7t-x-x-90">&#x00A0;!=</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor920"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">)</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-84023r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;log_info(</span><span 
class="colorbox" id="colorbox921"><span id="textcolor922"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox923"><span id="textcolor924"><span 
class="pcrr7t-x-x-90">CONFIG:</span><span 
class="pcrr7t-x-x-90">&#x00A0;%.&#x22C6;s</span></span></span><span 
class="colorbox" id="colorbox925"><span id="textcolor926"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;(</span><span id="textcolor927"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">)len,</span><span 
class="pcrr7t-x-x-90">&#x00A0;data);</span>
<br class="fancyvrb" /><a 
 id="x8-84025r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-84027r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84029r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;free(data);</span>
<br class="fancyvrb" /><a 
 id="x8-84031r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84033r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor928"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;CLOSE;</span>
<br class="fancyvrb" /><a 
 id="x8-84035r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-84037r18"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84039r19"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84041r20"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;StateEvent</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor929"><span 
class="pcrb7t-x-x-90">filter_init</span></span><span 
class="pcrr7t-x-x-90">(Server</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;srv,</span><span 
class="pcrr7t-x-x-90">&#x00A0;bstring</span><span 
class="pcrr7t-x-x-90">&#x00A0;load_path,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor930"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;out_nstates)</span>
<br class="fancyvrb" /><a 
 id="x8-84043r21"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-84045r22"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;StateEvent</span><span 
class="pcrr7t-x-x-90">&#x00A0;states[]</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;{HANDLER,</span><span 
class="pcrr7t-x-x-90">&#x00A0;PROXY};</span>
<br class="fancyvrb" /><a 
 id="x8-84047r23"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;out_nstates</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;Filter_states_length(states);</span>
<br class="fancyvrb" /><a 
 id="x8-84049r24"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;check(&#x22C6;out_nstates</span><span 
class="pcrr7t-x-x-90">&#x00A0;==</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor931"><span 
class="pcrb7t-x-x-90">2</span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="colorbox" id="colorbox932"><span id="textcolor933"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox934"><span id="textcolor935"><span 
class="pcrr7t-x-x-90">Wrong</span><span 
class="pcrr7t-x-x-90">&#x00A0;state</span><span 
class="pcrr7t-x-x-90">&#x00A0;array</span><span 
class="pcrr7t-x-x-90">&#x00A0;length.</span></span></span><span 
class="colorbox" id="colorbox936"><span id="textcolor937"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">);</span>
<br class="fancyvrb" /><a 
 id="x8-84051r25"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84053r26"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor938"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;Filter_state_list(states,</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;out_nstates);</span>
<br class="fancyvrb" /><a 
 id="x8-84055r27"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-84057r28"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor939"><span 
class="pcrro7t-x-x-90">error:</span></span>
<br class="fancyvrb" /><a 
 id="x8-84059r29"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor940"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor941"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-84061r30"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 847--><p class="noindent" >In this code you are basically creating a .so file that Mongrel2 will load on the
fly when told to. How it works is you make two functions, always named
<span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_init </span>and <span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_transition</span>.
<!--l. 851--><p class="noindent" >The <span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_init </span>function sets up a simple array that lists all of the events (found
in <span 
class="pcrro7t-">src/events.h</span>) that you want to have your filter triggered on. It&#8217;s important that
you use the <span 
class="pcrro7t-">Filter</span><span 
class="pcrro7t-">_state</span><span 
class="pcrro7t-">_list </span>function to return the actual list or else you&#8217;ll get
the memory allocation wrong.
<!--l. 857--><p class="noindent" >Mongrel2 will load this null.so and call the <span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_init </span>function and wire it up
for each of the events you indicate. Next, when a request comes in, the server will go
through each event that triggers, and call your <span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_transition </span>function. This
function will get the <span 
class="pcrro7t-">StateEvent </span>that is about to happen, the <span 
class="pcrro7t-">Connection </span>it&#8217;s
happening on, and finally, the <span 
class="pcrro7t-">config </span>that the user set in their <span 
class="pcrb7t-">config.sqlite</span>
database.
<!--l. 865--><p class="noindent" >All your <span 
class="pcrro7t-">filter</span><span 
class="pcrro7t-">_transition </span>function has to do is use the Mongrel2 APIs to do
what it needs, alter the <span 
class="pcrro7t-">Connection </span>and work with the <span 
class="pcrro7t-">config </span>to get its work
done. When it&#8217;s done, it can then return the next state event that Mongrel2 should
work with instead of what you were handed (or, just return the same one if you
aren&#8217;t changing how Mongrel2 works).
<!--l. 872--><p class="noindent" >That&#8217;s all there is to it for now. Later releases will start having more filters that you
can load and look at the example code to try.
<h3 class="sectionHead"><span class="titlemark">5.9    </span> <a 
 id="x8-850005.9"></a>Other Language APIs</h3>
<!--l. 877--><p class="noindent" >There&#8217;s at least 10 langauges available for Mongrel2, so check out the main
<a 
href="http://mongrel2.org" >mongrel2.org site</a> for the full list.
<!--l. 880--><p class="noindent" >If you want to implement another language, it should be fairly trivial. Just base your
design on the Python API so that it is consistent, but, please, don&#8217;t be a
slave to the Python design if it doesn&#8217;t fit the chosen language; creating a
direct translation of the Python is fine at first, but try to make it idiomatic
after that so people who use that language feel at home and it&#8217;s easy for
them.
<!--l. 888--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.10    </span> <a 
 id="x8-860005.10"></a>Writing Your Own m2sh</h3>
                                                                  

                                                                  
<!--l. 890--><p class="noindent" >The very last thing I will cover in the section on hacking Mongrel2
is how to write your own <span 
class="pcrro7t-">m2sh </span>script in your favorite language.
Obviously, if you&#8217;re doing this you should probably have a good
reason<span class="footnote-mark"><a 
href="#fn4x7" id="fn4x7-bk"><sup class="textsuperscript">4</sup></a></span><a 
 id="x8-86001f4"></a>.
What writing your own, or understanding what <span 
class="pcrro7t-">m2sh </span>is doing will do for you,
though, is help you when you start to think about automating Mongrel2 for your
deployments.
<!--l. 898--><p class="noindent" >Hopefully, I may have motivated you to automate, automate, automate. This is why
we write software. If I wanted to do stuff manually I&#8217;d go play guitars or juggle. I
write software because I want a computer to do things for me, and nothing needs
this more than managing your systems.
<!--l. 903--><p class="noindent" >This is why Mongrel2 is designed the way it is, using the MVC model. It lets <span 
class="pplri7t-">you</span>
create your own View like m2sh, web interfaces, automation scripts, and anything
else you need to make it easier to manage more.
<!--l. 907--><p class="noindent" >If you want to write your own <span 
class="pcrro7t-">m2sh </span>then first go have a look at the Python code in
<span 
class="pcrb7t-">examples/python/config </span>and the <span 
class="pcrro7t-">m2shpy </span>script that installs. This is where each
command lives, where the argument parsing is and, most importantly, the ORM
model that works the raw SQLite database.
<!--l. 912--><p class="noindent" >The next thing to do is to make your tool craft databases and compare the results to
what m2sh does for a similar configuration. I recommend you make a database that&#8217;s
&#8220;correct&#8221; with m2sh, and then dump it via <span 
class="pcrro7t-">sqlite3</span>. After that, use your tool to
make your own database, dump it, and then use <span 
class="pcrro7t-">diff </span>to compare your results to
mine.
<!--l. 918--><p class="noindent" >You can also look at how the C version of m2sh that is installed by default is
written. It lives in <span 
class="pcrb7t-">tools/m2sh </span>and has a completely different design but does
nearly the same things. If you know C then this comparing the two is also
educational.
<!--l. 923--><p class="noindent" >Finally, you&#8217;ll need to look at two base schema files: <span 
class="pcrb7t-">src/config/config.sql</span>
and <span 
class="pcrb7t-">src/config/mimetypes.sql</span>, where the database schema
is created and the large list of mimetypes that Mongrel2 knows is
stored.<span class="footnote-mark"><a 
href="#fn5x7" id="fn5x7-bk"><sup class="textsuperscript">5</sup></a></span><a 
 id="x8-86002f5"></a>
Your tool should be able to use this SQL to make its database, or at least know what
it does.
<!--l. 930--><p class="noindent" >If you do something cool with all of this, let us know.
<!--l. 933--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">5.11    </span> <a 
 id="x8-870005.11"></a>Config From Anything: Experimental</h3>
                                                                  

                                                                  
<!--l. 935--><p class="noindent" >As of v1.7 Mongrel2 has the ability to configure itself directly from a loadable
module that you can define. The feature is very new and probably not safe to use
quite yet, but I&#8217;m documenting it here so that people can start playing with it and
then giving me feedback on how to use it.
<!--l. 940--><p class="noindent" >The first thing to look at is the null.so module in <span 
class="pcrb7t-">tools/config</span><span 
class="pcrb7t-">_modules/null.c</span>
which lays out a bare config module that automatically fails. This module was using
in unit testing to make sure that Mongrel2 handles some simple invalid inputs to the
configuration system. Here&#8217;s the code to the module:
                                                                  

                                                                  
<!--l. 945--><p class="noindent" ><a 
 id="x8-87001r40"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 40: </span><span  
class="content">                                                                                             <span 
class="pplri7t-">The null Config</span>
<span 
class="pplri7t-">Module</span></span></div><!--tex4ht:label?: x8-87001r40 -->
<div class="fancyvrb" id="fancyvrb41">
<a 
 id="x8-87003r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor942"><span 
class="pcrr7t-x-x-90">/&#x22C6;&#x22C6;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87005r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor943"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87007r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor944"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Copyright</span><span 
class="pcrr7t-x-x-90">&#x00A0;(c)</span><span 
class="pcrr7t-x-x-90">&#x00A0;2010,</span><span 
class="pcrr7t-x-x-90">&#x00A0;Zed</span><span 
class="pcrr7t-x-x-90">&#x00A0;A.</span><span 
class="pcrr7t-x-x-90">&#x00A0;Shaw</span><span 
class="pcrr7t-x-x-90">&#x00A0;and</span><span 
class="pcrr7t-x-x-90">&#x00A0;Mongrel2</span><span 
class="pcrr7t-x-x-90">&#x00A0;Project</span><span 
class="pcrr7t-x-x-90">&#x00A0;Contributors.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87009r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor945"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;All</span><span 
class="pcrr7t-x-x-90">&#x00A0;rights</span><span 
class="pcrr7t-x-x-90">&#x00A0;reserved.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87011r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor946"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87013r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor947"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Redistribution</span><span 
class="pcrr7t-x-x-90">&#x00A0;and</span><span 
class="pcrr7t-x-x-90">&#x00A0;use</span><span 
class="pcrr7t-x-x-90">&#x00A0;in</span><span 
class="pcrr7t-x-x-90">&#x00A0;source</span><span 
class="pcrr7t-x-x-90">&#x00A0;and</span><span 
class="pcrr7t-x-x-90">&#x00A0;binary</span><span 
class="pcrr7t-x-x-90">&#x00A0;forms,</span><span 
class="pcrr7t-x-x-90">&#x00A0;with</span><span 
class="pcrr7t-x-x-90">&#x00A0;or</span><span 
class="pcrr7t-x-x-90">&#x00A0;without</span></span>
<br class="fancyvrb" /><a 
 id="x8-87015r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor948"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;modification,</span><span 
class="pcrr7t-x-x-90">&#x00A0;are</span><span 
class="pcrr7t-x-x-90">&#x00A0;permitted</span><span 
class="pcrr7t-x-x-90">&#x00A0;provided</span><span 
class="pcrr7t-x-x-90">&#x00A0;that</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;following</span><span 
class="pcrr7t-x-x-90">&#x00A0;conditions</span><span 
class="pcrr7t-x-x-90">&#x00A0;are</span></span>
<br class="fancyvrb" /><a 
 id="x8-87017r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor949"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;met:</span></span>
<br class="fancyvrb" /><a 
 id="x8-87019r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor950"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87021r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor951"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Redistributions</span><span 
class="pcrr7t-x-x-90">&#x00A0;of</span><span 
class="pcrr7t-x-x-90">&#x00A0;source</span><span 
class="pcrr7t-x-x-90">&#x00A0;code</span><span 
class="pcrr7t-x-x-90">&#x00A0;must</span><span 
class="pcrr7t-x-x-90">&#x00A0;retain</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;above</span><span 
class="pcrr7t-x-x-90">&#x00A0;copyright</span></span>
<br class="fancyvrb" /><a 
 id="x8-87023r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor952"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;notice,</span><span 
class="pcrr7t-x-x-90">&#x00A0;this</span><span 
class="pcrr7t-x-x-90">&#x00A0;list</span><span 
class="pcrr7t-x-x-90">&#x00A0;of</span><span 
class="pcrr7t-x-x-90">&#x00A0;conditions</span><span 
class="pcrr7t-x-x-90">&#x00A0;and</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;following</span><span 
class="pcrr7t-x-x-90">&#x00A0;disclaimer.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87025r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor953"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87027r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor954"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Redistributions</span><span 
class="pcrr7t-x-x-90">&#x00A0;in</span><span 
class="pcrr7t-x-x-90">&#x00A0;binary</span><span 
class="pcrr7t-x-x-90">&#x00A0;form</span><span 
class="pcrr7t-x-x-90">&#x00A0;must</span><span 
class="pcrr7t-x-x-90">&#x00A0;reproduce</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;above</span><span 
class="pcrr7t-x-x-90">&#x00A0;copyright</span></span>
<br class="fancyvrb" /><a 
 id="x8-87029r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor955"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;notice,</span><span 
class="pcrr7t-x-x-90">&#x00A0;this</span><span 
class="pcrr7t-x-x-90">&#x00A0;list</span><span 
class="pcrr7t-x-x-90">&#x00A0;of</span><span 
class="pcrr7t-x-x-90">&#x00A0;conditions</span><span 
class="pcrr7t-x-x-90">&#x00A0;and</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;following</span><span 
class="pcrr7t-x-x-90">&#x00A0;disclaimer</span><span 
class="pcrr7t-x-x-90">&#x00A0;in</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span></span>
<br class="fancyvrb" /><a 
 id="x8-87031r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor956"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;documentation</span><span 
class="pcrr7t-x-x-90">&#x00A0;and/or</span><span 
class="pcrr7t-x-x-90">&#x00A0;other</span><span 
class="pcrr7t-x-x-90">&#x00A0;materials</span><span 
class="pcrr7t-x-x-90">&#x00A0;provided</span><span 
class="pcrr7t-x-x-90">&#x00A0;with</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;distribution.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87033r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor957"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87035r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor958"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;Neither</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;name</span><span 
class="pcrr7t-x-x-90">&#x00A0;of</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;Mongrel2</span><span 
class="pcrr7t-x-x-90">&#x00A0;Project,</span><span 
class="pcrr7t-x-x-90">&#x00A0;Zed</span><span 
class="pcrr7t-x-x-90">&#x00A0;A.</span><span 
class="pcrr7t-x-x-90">&#x00A0;Shaw,</span><span 
class="pcrr7t-x-x-90">&#x00A0;nor</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;names</span></span>
<br class="fancyvrb" /><a 
 id="x8-87037r18"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor959"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;of</span><span 
class="pcrr7t-x-x-90">&#x00A0;its</span><span 
class="pcrr7t-x-x-90">&#x00A0;contributors</span><span 
class="pcrr7t-x-x-90">&#x00A0;may</span><span 
class="pcrr7t-x-x-90">&#x00A0;be</span><span 
class="pcrr7t-x-x-90">&#x00A0;used</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;endorse</span><span 
class="pcrr7t-x-x-90">&#x00A0;or</span><span 
class="pcrr7t-x-x-90">&#x00A0;promote</span><span 
class="pcrr7t-x-x-90">&#x00A0;products</span></span>
<br class="fancyvrb" /><a 
 id="x8-87039r19"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor960"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;derived</span><span 
class="pcrr7t-x-x-90">&#x00A0;from</span><span 
class="pcrr7t-x-x-90">&#x00A0;this</span><span 
class="pcrr7t-x-x-90">&#x00A0;software</span><span 
class="pcrr7t-x-x-90">&#x00A0;without</span><span 
class="pcrr7t-x-x-90">&#x00A0;specific</span><span 
class="pcrr7t-x-x-90">&#x00A0;prior</span><span 
class="pcrr7t-x-x-90">&#x00A0;written</span></span>
<br class="fancyvrb" /><a 
 id="x8-87041r20"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor961"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;permission.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87043r21"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor962"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87045r22"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor963"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;THIS</span><span 
class="pcrr7t-x-x-90">&#x00A0;SOFTWARE</span><span 
class="pcrr7t-x-x-90">&#x00A0;IS</span><span 
class="pcrr7t-x-x-90">&#x00A0;PROVIDED</span><span 
class="pcrr7t-x-x-90">&#x00A0;BY</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;COPYRIGHT</span><span 
class="pcrr7t-x-x-90">&#x00A0;HOLDERS</span><span 
class="pcrr7t-x-x-90">&#x00A0;AND</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONTRIBUTORS</span><span 
class="pcrr7t-x-x-90">&#x00A0;"AS</span></span>
<br class="fancyvrb" /><a 
 id="x8-87047r23"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor964"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;IS"</span><span 
class="pcrr7t-x-x-90">&#x00A0;AND</span><span 
class="pcrr7t-x-x-90">&#x00A0;ANY</span><span 
class="pcrr7t-x-x-90">&#x00A0;EXPRESS</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;IMPLIED</span><span 
class="pcrr7t-x-x-90">&#x00A0;WARRANTIES,</span><span 
class="pcrr7t-x-x-90">&#x00A0;INCLUDING,</span><span 
class="pcrr7t-x-x-90">&#x00A0;BUT</span><span 
class="pcrr7t-x-x-90">&#x00A0;NOT</span><span 
class="pcrr7t-x-x-90">&#x00A0;LIMITED</span><span 
class="pcrr7t-x-x-90">&#x00A0;TO,</span></span>
<br class="fancyvrb" /><a 
 id="x8-87049r24"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor965"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;IMPLIED</span><span 
class="pcrr7t-x-x-90">&#x00A0;WARRANTIES</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;MERCHANTABILITY</span><span 
class="pcrr7t-x-x-90">&#x00A0;AND</span><span 
class="pcrr7t-x-x-90">&#x00A0;FITNESS</span><span 
class="pcrr7t-x-x-90">&#x00A0;FOR</span><span 
class="pcrr7t-x-x-90">&#x00A0;A</span><span 
class="pcrr7t-x-x-90">&#x00A0;PARTICULAR</span></span>
<br class="fancyvrb" /><a 
 id="x8-87051r25"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor966"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;PURPOSE</span><span 
class="pcrr7t-x-x-90">&#x00A0;ARE</span><span 
class="pcrr7t-x-x-90">&#x00A0;DISCLAIMED.</span><span 
class="pcrr7t-x-x-90">&#x00A0;IN</span><span 
class="pcrr7t-x-x-90">&#x00A0;NO</span><span 
class="pcrr7t-x-x-90">&#x00A0;EVENT</span><span 
class="pcrr7t-x-x-90">&#x00A0;SHALL</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;COPYRIGHT</span><span 
class="pcrr7t-x-x-90">&#x00A0;HOLDER</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span></span>
<br class="fancyvrb" /><a 
 id="x8-87053r26"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor967"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONTRIBUTORS</span><span 
class="pcrr7t-x-x-90">&#x00A0;BE</span><span 
class="pcrr7t-x-x-90">&#x00A0;LIABLE</span><span 
class="pcrr7t-x-x-90">&#x00A0;FOR</span><span 
class="pcrr7t-x-x-90">&#x00A0;ANY</span><span 
class="pcrr7t-x-x-90">&#x00A0;DIRECT,</span><span 
class="pcrr7t-x-x-90">&#x00A0;INDIRECT,</span><span 
class="pcrr7t-x-x-90">&#x00A0;INCIDENTAL,</span><span 
class="pcrr7t-x-x-90">&#x00A0;SPECIAL,</span></span>
<br class="fancyvrb" /><a 
 id="x8-87055r27"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor968"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;EXEMPLARY,</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONSEQUENTIAL</span><span 
class="pcrr7t-x-x-90">&#x00A0;DAMAGES</span><span 
class="pcrr7t-x-x-90">&#x00A0;(INCLUDING,</span><span 
class="pcrr7t-x-x-90">&#x00A0;BUT</span><span 
class="pcrr7t-x-x-90">&#x00A0;NOT</span><span 
class="pcrr7t-x-x-90">&#x00A0;LIMITED</span><span 
class="pcrr7t-x-x-90">&#x00A0;TO,</span></span>
<br class="fancyvrb" /><a 
 id="x8-87057r28"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor969"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;PROCUREMENT</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;SUBSTITUTE</span><span 
class="pcrr7t-x-x-90">&#x00A0;GOODS</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;SERVICES;</span><span 
class="pcrr7t-x-x-90">&#x00A0;LOSS</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;USE,</span><span 
class="pcrr7t-x-x-90">&#x00A0;DATA,</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span></span>
<br class="fancyvrb" /><a 
 id="x8-87059r29"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor970"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;PROFITS;</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;BUSINESS</span><span 
class="pcrr7t-x-x-90">&#x00A0;INTERRUPTION)</span><span 
class="pcrr7t-x-x-90">&#x00A0;HOWEVER</span><span 
class="pcrr7t-x-x-90">&#x00A0;CAUSED</span><span 
class="pcrr7t-x-x-90">&#x00A0;AND</span><span 
class="pcrr7t-x-x-90">&#x00A0;ON</span><span 
class="pcrr7t-x-x-90">&#x00A0;ANY</span><span 
class="pcrr7t-x-x-90">&#x00A0;THEORY</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span></span>
<br class="fancyvrb" /><a 
 id="x8-87061r30"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor971"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;LIABILITY,</span><span 
class="pcrr7t-x-x-90">&#x00A0;WHETHER</span><span 
class="pcrr7t-x-x-90">&#x00A0;IN</span><span 
class="pcrr7t-x-x-90">&#x00A0;CONTRACT,</span><span 
class="pcrr7t-x-x-90">&#x00A0;STRICT</span><span 
class="pcrr7t-x-x-90">&#x00A0;LIABILITY,</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;TORT</span><span 
class="pcrr7t-x-x-90">&#x00A0;(INCLUDING</span></span>
<br class="fancyvrb" /><a 
 id="x8-87063r31"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor972"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;NEGLIGENCE</span><span 
class="pcrr7t-x-x-90">&#x00A0;OR</span><span 
class="pcrr7t-x-x-90">&#x00A0;OTHERWISE)</span><span 
class="pcrr7t-x-x-90">&#x00A0;ARISING</span><span 
class="pcrr7t-x-x-90">&#x00A0;IN</span><span 
class="pcrr7t-x-x-90">&#x00A0;ANY</span><span 
class="pcrr7t-x-x-90">&#x00A0;WAY</span><span 
class="pcrr7t-x-x-90">&#x00A0;OUT</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;USE</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;THIS</span></span>
<br class="fancyvrb" /><a 
 id="x8-87065r32"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor973"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span 
class="pcrr7t-x-x-90">&#x00A0;SOFTWARE,</span><span 
class="pcrr7t-x-x-90">&#x00A0;EVEN</span><span 
class="pcrr7t-x-x-90">&#x00A0;IF</span><span 
class="pcrr7t-x-x-90">&#x00A0;ADVISED</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;THE</span><span 
class="pcrr7t-x-x-90">&#x00A0;POSSIBILITY</span><span 
class="pcrr7t-x-x-90">&#x00A0;OF</span><span 
class="pcrr7t-x-x-90">&#x00A0;SUCH</span><span 
class="pcrr7t-x-x-90">&#x00A0;DAMAGE.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87067r33"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor974"><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;/</span></span>
<br class="fancyvrb" /><a 
 id="x8-87069r34"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87071r35"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor975"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor976"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;filter.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87073r36"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor977"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor978"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;dbg.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87075r37"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor979"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor980"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;config</span></span><span id="textcolor981"><span 
class="pcrb7t-x-x-90">/</span></span><span id="textcolor982"><span 
class="pcrb7t-x-x-90">module.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87077r38"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor983"><span 
class="pcrb7t-x-x-90">#</span></span><span id="textcolor984"><span 
class="pcrb7t-x-x-90">include</span><span 
class="pcrb7t-x-x-90">&#x00A0;&#x003C;config</span></span><span id="textcolor985"><span 
class="pcrb7t-x-x-90">/</span></span><span id="textcolor986"><span 
class="pcrb7t-x-x-90">db.h&#x003E;</span></span>
<br class="fancyvrb" /><a 
 id="x8-87079r39"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87081r40"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor987"><span 
class="pcrb7t-x-x-90">struct</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;tagbstring</span><span 
class="pcrr7t-x-x-90">&#x00A0;GOODPATH</span><span 
class="pcrr7t-x-x-90">&#x00A0;=</span><span 
class="pcrr7t-x-x-90">&#x00A0;bsStatic(</span><span 
class="colorbox" id="colorbox988"><span id="textcolor989"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox990"><span id="textcolor991"><span 
class="pcrr7t-x-x-90">goodpath</span></span></span><span 
class="colorbox" id="colorbox992"><span id="textcolor993"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">);</span>
<br class="fancyvrb" /><a 
 id="x8-87083r41"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87085r42"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor994"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor995"><span 
class="pcrb7t-x-x-90">config_init</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor996"><span 
class="pcrb7t-x-x-90">const</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor997"><span 
class="pcrb7t-x-x-90">char</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;path)</span>
<br class="fancyvrb" /><a 
 id="x8-87087r43"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87089r44"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor998"><span 
class="pcrb7t-x-x-90">if</span></span><span 
class="pcrr7t-x-x-90">(biseqcstr(&amp;GOODPATH,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path))</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87091r45"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;log_info(</span><span 
class="colorbox" id="colorbox999"><span id="textcolor1000"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox1001"><span id="textcolor1002"><span 
class="pcrr7t-x-x-90">Got</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;good</span><span 
class="pcrr7t-x-x-90">&#x00A0;path.</span></span></span><span 
class="colorbox" id="colorbox1003"><span id="textcolor1004"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">);</span>
                                                                  

                                                                  
<br class="fancyvrb" /><a 
 id="x8-87093r46"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1005"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1006"><span 
class="pcrb7t-x-x-90">0</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87095r47"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1007"><span 
class="pcrb7t-x-x-90">else</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87097r48"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;log_info(</span><span 
class="colorbox" id="colorbox1008"><span id="textcolor1009"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="colorbox" id="colorbox1010"><span id="textcolor1011"><span 
class="pcrr7t-x-x-90">Got</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;bad</span><span 
class="pcrr7t-x-x-90">&#x00A0;path:</span><span 
class="pcrr7t-x-x-90">&#x00A0;%s</span></span></span><span 
class="colorbox" id="colorbox1012"><span id="textcolor1013"><span 
class="pcrr7t-x-x-90">"</span></span></span><span 
class="pcrr7t-x-x-90">,</span><span 
class="pcrr7t-x-x-90">&#x00A0;path);</span>
<br class="fancyvrb" /><a 
 id="x8-87099r49"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1014"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;-</span><span id="textcolor1015"><span 
class="pcrb7t-x-x-90">1</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87101r50"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87103r51"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87105r52"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87107r53"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1016"><span 
class="pcrb7t-x-x-90">void</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1017"><span 
class="pcrb7t-x-x-90">config_close</span></span><span 
class="pcrr7t-x-x-90">()</span>
<br class="fancyvrb" /><a 
 id="x8-87109r54"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87111r55"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87113r56"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87115r57"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1018"><span 
class="pcrb7t-x-x-90">config_load_handler</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1019"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;handler_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87117r58"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87119r59"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1020"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1021"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87121r60"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87123r61"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87125r62"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1022"><span 
class="pcrb7t-x-x-90">config_load_proxy</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1023"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;proxy_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87127r63"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87129r64"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1024"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1025"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87131r65"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87133r66"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87135r67"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1026"><span 
class="pcrb7t-x-x-90">config_load_dir</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1027"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;dir_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87137r68"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87139r69"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1028"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1029"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87141r70"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87143r71"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87145r72"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1030"><span 
class="pcrb7t-x-x-90">config_load_routes</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1031"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;host_id,</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1032"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;server_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87147r73"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87149r74"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1033"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1034"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87151r75"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87153r76"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87155r77"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1035"><span 
class="pcrb7t-x-x-90">config_load_hosts</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1036"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;server_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87157r78"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87159r79"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1037"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1038"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87161r80"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87163r81"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87165r82"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1039"><span 
class="pcrb7t-x-x-90">config_load_server</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1040"><span 
class="pcrb7t-x-x-90">const</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1041"><span 
class="pcrb7t-x-x-90">char</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;uuid)</span>
<br class="fancyvrb" /><a 
 id="x8-87167r83"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87169r84"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1042"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1043"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87171r85"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87173r86"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87175r87"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87177r88"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1044"><span 
class="pcrb7t-x-x-90">config_load_mimetypes</span></span><span 
class="pcrr7t-x-x-90">()</span>
<br class="fancyvrb" /><a 
 id="x8-87179r89"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87181r90"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1045"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1046"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87183r91"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87185r92"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87187r93"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1047"><span 
class="pcrb7t-x-x-90">config_load_settings</span></span><span 
class="pcrr7t-x-x-90">()</span>
<br class="fancyvrb" /><a 
 id="x8-87189r94"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87191r95"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1048"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1049"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
                                                                  

                                                                  
<br class="fancyvrb" /><a 
 id="x8-87193r96"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
<br class="fancyvrb" /><a 
 id="x8-87195r97"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87197r98"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;tns_value_t</span><span 
class="pcrr7t-x-x-90">&#x00A0;&#x22C6;</span><span id="textcolor1050"><span 
class="pcrb7t-x-x-90">config_load_filters</span></span><span 
class="pcrr7t-x-x-90">(</span><span id="textcolor1051"><span 
class="pcrb7t-x-x-90">int</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;server_id)</span>
<br class="fancyvrb" /><a 
 id="x8-87199r99"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;{</span>
<br class="fancyvrb" /><a 
 id="x8-87201r100"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1052"><span 
class="pcrb7t-x-x-90">return</span></span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1053"><span 
class="pcrr7t-x-x-90">NULL</span></span><span 
class="pcrr7t-x-x-90">;</span>
<br class="fancyvrb" /><a 
 id="x8-87203r101"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;}</span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 1052--><p class="noindent" >You can then get Mongrel2 to load this module directly by passing it as a fourth
parameter to the <span 
class="pcrb7t-">mongrel2 </span>executable:
                                                                  

                                                                  
<!--l. 1055--><p class="noindent" ><a 
 id="x8-87204r41"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Source 41: </span><span  
class="content">                                                                                          <span 
class="pplri7t-">Loading The null</span>
<span 
class="pplri7t-">Config</span></span></div><!--tex4ht:label?: x8-87204r41 -->
<div class="fancyvrb" id="fancyvrb42">
<a 
 id="x8-87206r1"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;mongrel2</span><span 
class="pcrr7t-x-x-90">&#x00A0;goodpath</span><span 
class="pcrr7t-x-x-90">&#x00A0;2f62bd5-9e59-49cd-993c-3b6013c28f05</span><span 
class="pcrr7t-x-x-90">&#x00A0;/usr/local/lib/mongrel2/config_modules/null.so</span>
<br class="fancyvrb" /><a 
 id="x8-87208r2"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87210r3"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1054"><span 
class="pcrr7t-x-x-90">#</span><span 
class="pcrr7t-x-x-90">&#x00A0;OUTPUT:</span></span>
<br class="fancyvrb" /><a 
 id="x8-87212r4"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1055"><span 
class="pcrr7t-x-x-90">#[INFO]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:320)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Using</span><span 
class="pcrr7t-x-x-90">&#x00A0;configuration</span><span 
class="pcrr7t-x-x-90">&#x00A0;module</span><span 
class="pcrr7t-x-x-90">&#x00A0;/usr/local/lib/mongrel2/config_modules/null.so</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;configs.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87214r5"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1056"><span 
class="pcrr7t-x-x-90">#[INFO]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(null.c:11)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Got</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;good</span><span 
class="pcrr7t-x-x-90">&#x00A0;path.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87216r6"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1057"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/config/config.c:366:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Wrong</span><span 
class="pcrr7t-x-x-90">&#x00A0;type,</span><span 
class="pcrr7t-x-x-90">&#x00A0;expected</span><span 
class="pcrr7t-x-x-90">&#x00A0;valid</span><span 
class="pcrr7t-x-x-90">&#x00A0;rows.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87218r7"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1058"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:124:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Failed</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;global</span><span 
class="pcrr7t-x-x-90">&#x00A0;settings.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87220r8"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1059"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:326:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Aborting</span><span 
class="pcrr7t-x-x-90">&#x00A0;since</span><span 
class="pcrr7t-x-x-90">&#x00A0;can't</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;server.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87222r9"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1060"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:362:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Exiting</span><span 
class="pcrr7t-x-x-90">&#x00A0;due</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;error.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87224r10"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87226r11"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;mongrel2</span><span 
class="pcrr7t-x-x-90">&#x00A0;badpath</span><span 
class="pcrr7t-x-x-90">&#x00A0;2f62bd5-9e59-49cd-993c-3b6013c28f05</span><span 
class="pcrr7t-x-x-90">&#x00A0;/usr/local/lib/mongrel2/config_modules/null.so</span>
<br class="fancyvrb" /><a 
 id="x8-87228r12"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x8-87230r13"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1061"><span 
class="pcrr7t-x-x-90">#[INFO]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:320)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Using</span><span 
class="pcrr7t-x-x-90">&#x00A0;configuration</span><span 
class="pcrr7t-x-x-90">&#x00A0;module</span><span 
class="pcrr7t-x-x-90">&#x00A0;/usr/local/lib/mongrel2/config_modules/null.so</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;configs.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87232r14"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1062"><span 
class="pcrr7t-x-x-90">#[INFO]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(null.c:14)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Got</span><span 
class="pcrr7t-x-x-90">&#x00A0;the</span><span 
class="pcrr7t-x-x-90">&#x00A0;bad</span><span 
class="pcrr7t-x-x-90">&#x00A0;path:</span><span 
class="pcrr7t-x-x-90">&#x00A0;badpath</span></span>
<br class="fancyvrb" /><a 
 id="x8-87234r15"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1063"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:121:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Failed</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;config</span><span 
class="pcrr7t-x-x-90">&#x00A0;database</span><span 
class="pcrr7t-x-x-90">&#x00A0;at</span><span 
class="pcrr7t-x-x-90">&#x00A0;badpath</span></span>
<br class="fancyvrb" /><a 
 id="x8-87236r16"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1064"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:326:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Aborting</span><span 
class="pcrr7t-x-x-90">&#x00A0;since</span><span 
class="pcrr7t-x-x-90">&#x00A0;can't</span><span 
class="pcrr7t-x-x-90">&#x00A0;load</span><span 
class="pcrr7t-x-x-90">&#x00A0;server.</span></span>
<br class="fancyvrb" /><a 
 id="x8-87238r17"></a><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span 
class="pcrr7t-x-x-90">&#x00A0;</span><span id="textcolor1065"><span 
class="pcrr7t-x-x-90">#[ERROR]</span><span 
class="pcrr7t-x-x-90">&#x00A0;(src/mongrel2.c:362:</span><span 
class="pcrr7t-x-x-90">&#x00A0;errno:</span><span 
class="pcrr7t-x-x-90">&#x00A0;None)</span><span 
class="pcrr7t-x-x-90">&#x00A0;Exiting</span><span 
class="pcrr7t-x-x-90">&#x00A0;due</span><span 
class="pcrr7t-x-x-90">&#x00A0;to</span><span 
class="pcrr7t-x-x-90">&#x00A0;error.</span></span>
</div>
                                                                  

                                                                  
</div><hr class="endfloat" />
<!--l. 1078--><p class="noindent" >In this run, Mongrel2 detected that you gave it a fourth option and loaded
that as the module to use for configuring itself. Normally it just assumes a
sqlite3 database, but now it&#8217;s going to defer everything to the null.c code
above. It also passes the 2nd parameter (the path) and 3rd (the UUID) to the
module for the operations it needs to do. Mongrel2 also doesn&#8217;t enforce
anything for these strings other than they were arguments, so you don&#8217;t have to
use any real paths or UUIDs so long as your module can return the right
data.
<!--l. 1087--><p class="noindent" >What you then have to do to make your own config module is:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x8-87240x1">Copy the null.c file to a new file in <span 
class="pcrb7t-">tools/config</span><span 
class="pcrb7t-">_modules</span>.
     </li>
     <li 
  class="enumerate" id="x8-87242x2">Add      your      .so      to      the      list      of      ones      to      build      in
     <span 
class="pcrb7t-">tools/config</span><span 
class="pcrb7t-">_modules/Makefile</span>.
     </li>
     <li 
  class="enumerate" id="x8-87244x3">Run make to confirm that it builds, then <span class="obeylines-h"><span class="verb"><span 
class="pcrr7t-">sudo</span><span 
class="pcrr7t-">&#x00A0;make</span><span 
class="pcrr7t-">&#x00A0;install</span></span></span> to make
     sure it shows up in <span 
class="pcrb8c-">$</span><span 
class="pcrb7t-">PREFIX/lib/mongrel2/config</span><span 
class="pcrb7t-">_modules</span>.
     </li>
     <li 
  class="enumerate" id="x8-87246x4">Start making each function return the right <span class="obeylines-h"><span class="verb"><span 
class="pcrr7t-">tns_value_t</span><span 
class="pcrr7t-">&#x00A0;&#x22C6;</span></span></span> results that
     it needs. Look at src/config/module.c for what is currently being used.
     </li>
     <li 
  class="enumerate" id="x8-87248x5">Look at <span 
class="pcrb7t-">tests/config</span><span 
class="pcrb7t-">_tests.c:test</span><span 
class="pcrb7t-">_Config</span><span 
class="pcrb7t-">_load</span><span 
class="pcrb7t-">_module </span>and
     write a similar unit test to make sure it works right.</li></ol>
<!--l. 1098--><p class="noindent" >Finally, the protocol that&#8217;s being used is basically a translation of the sqlite3 tables
defined in the <span 
class="pcrb7t-">src/config/config.sql </span>schema into a TNetString data type that
Mongrel2 can understand. The queries are checked for every error I could think up,
and you should get meaningful error messages about column types. When it doubt,
just look at <span 
class="pcrb7t-">src/config/module.c </span>to see how it&#8217;s being done and then replicate it
exactly.
                                                                  

                                                                  
<!--l. 1104--><p class="noindent" ><a 
 id="x8-87249r11"></a><hr class="float"><div class="float" 
>
                                                                  

                                                                  
 <div class="caption" 
><span class="id">Note 11: </span><span  
class="content">                                                                                          <span 
class="pplri7t-">m2sh configuration</span>
<span 
class="pplri7t-">run</span></span></div><!--tex4ht:label?: x8-87249r11 -->
     <div class="quote">
     <!--l. 1104--><p class="indent" >   You&#8217;re On Your Own There&#8217;s also a way to run the same command
     using  <span 
class="pcrb7t-">m2sh</span>,  but  it&#8217;s  mostly  a  convenience  to  get  you  started.  If
     you&#8217;re doing your own configuration system it&#8217;s assumed that you
     probably aren&#8217;t using m2sh and have written your own. In order to
     make m2sh work with your config, we&#8217;d have to alter m2sh quite
     a lot and turn it into a generic &#8221;query the config&#8221; tool. That might
     happen, but it&#8217;s not there yet.
     <!--l. 1112--><p class="indent" >   Rather than confuse the issue, I&#8217;ll skip documenting it until a later
     release when it&#8217;s more robust. </div>
                                                                  

                                                                  
</div><hr class="endfloat" />
                                                                  

                                                                  
                                                                  

                                                                  
                                                                  

                                                                  
<div class="footnotes"><!--l. 225--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x7-bk" id="fn1x7"><sup class="textsuperscript">1</sup></a></span><span 
class="pplr7t-x-x-80">Except Erlang guys, &#8217;cause they&#8217;ll always complain that everything&#8217;s not in Erlang</span>
<!--l. 249--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x7-bk" id="fn2x7"><sup class="textsuperscript">2</sup></a></span><span 
class="pplr7t-x-x-80">The types of sockets used will be configurable in later version</span>
<!--l. 493--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn3x7-bk" id="fn3x7"><sup class="textsuperscript">3</sup></a></span><span 
class="pplr7t-x-x-80">This is the same code as the original file, but with extraneous prints removed for simplicity.</span>
<!--l. 894--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn4x7-bk" id="fn4x7"><sup class="textsuperscript">4</sup></a></span><span 
class="pplr7t-x-x-80">Like if you&#8217;re a Ruby weenie and C is banned at your company because they like dogma more than</span>
<span 
class="pplr7t-x-x-80">money.</span>
<!--l. 927--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn5x7-bk" id="fn5x7"><sup class="textsuperscript">5</sup></a></span><span 
class="pplr7t-x-x-80">Incidentally, if you want to add one, that&#8217;s the table to put it in.</span>                     </div> <!--l. 1--><div class="crosslinks"><p class="noindent">[<a 
href="book-finalch7.html" >next</a>]
[<a 
href="book-finalch5.html" >prev</a>] [<a 
href="book-finalch5.html#tailbook-finalch5.html" >prev-tail</a>] [<a 
href="book-finalch6.html" >front</a>] [<a 
href="book-final.html#book-finalch6.html" >up</a>] </p></div>
<!--l. 1--><p class="noindent" ><a 
 id="tailbook-finalch6.html"></a>  
</body></html> 
